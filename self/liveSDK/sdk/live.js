const GSSDK=require("./gssdk");var app=getApp();const GS=GSSDK.GS;const task=GSSDK.task;const tool=GSSDK.tool;const Parser=GSSDK.DOMParser;var startPlayCurrentTime=0;var JUMPTYPE_LIVE_UNOPEN="live_unopen";var JUMPTYPE_NOT_ENOUGH_AUTHORIZED="no_enough_authorized";var JUMPTYPE_TIP_COULD_OPEN="could_start_play";var JUMPTYPE_TIP_VIDEO_END="video_ended";var JUMPTYPE_TIP_WEBCASRT_PAUSE="pause";var JUMPTYPE_TIP_WEBCASRT_RESUME="resume";var JUMPTYPE_TIP_REPORT_LONGIN="report_login";var isAreadyTip_Ejectdup=false;var isAreadyTip_Unopen=false;var isAreadyTip_Authorized=false;var isAreadyTip_Open=false;var isAreadyTip_Pause=false;var isCouldTip_Resume=false;var isAreadyTip_End=false;var Gensee_VIDEO_Status=null;var Gensee_Deal_Function={PUSH_QA:"onTagAudio",ANSWER_QA:"onQAHighlight",CANCEL_QA:"onCancelHighlight"};var Gensee_SDK_Task_PPT_SDK="ppt_sdk";var Gensee_SDK_Task_ANNOTATION_SDK="anno_sdk";var Gensee_SDK_Task_PPT_MODULE="ppt_module";var toldPlayWebsocketCmd=false;var Gensee_VIDEO_START_CURRENT_TIME=null;var Gensee_Host_User_Id=null;var Gensee_Asker_User_Id=null;var Gensee_Roll_Call=null;var Gensee_Roll_Call_Timeout=null;var Gensee_Now_Doc_Url_SDK=null;var Gensee_Lottery_Start=1;var Gensee_Lottery_End=2;var Gensee_Lottery_Abort=3;var Gensee_STATUS_USER_LIST=null;var Gensee_ROLL_CALL_TYPE=null;var Gensee_UP_HOST=null;var Gensee_VIDEO_STATUS_CMD=null;var Gensee_VIDEO_START_INIT=false;var pauseObj={};var inittimestamp=0;var Gensee_Now_Status_Call=0;var Gensee_Status_Chat=true;var Gensee_Statu_default={USER_STATUS_DEFAULT:0,USER_STATUS_HAVE_AUDIO:1,USER_STATUS_HAVE_VIDEO:2,USER_STATUS_OPEN_AUDIO:4,USER_STATUS_OPEN_VIDEO:8,USER_STATUS_MUTE_AUDIO:16,USER_STATUS_MUTE_VIDEO:32,USER_REQUEST_UPGRADE:64,USER_STATUS_MUTE_CHAT:128,USER_STATUS_FOCUS:256,USER_STATUS_ROLLCALL_START:512,USER_STATUS_ROLLCALL_RESULT:1024,ROLLCALL_NOT_START:0,ROLLCALL_STARTING:1024,ROLLCALL_PRESENT:512,ROLLCALL_ABSENT:1536,WEB_AUDIO_INVITE:2048,WEB_AUDIO_CHATTING:4096,isFilterQuestion:false,isWantToUpgrade:false,isFocus:true,isActive:NaN,isMute:false,isAudioInviting:false,isAudioChatting:false};var Gensee_Status_QA=true;var waitnum=1;var ALBurl;var ALBBakUrl;var timeoutObj;var visitUrl="";var cdnEnabled=false;var pollingDealTime=0;var SESSIONID;var cdnUrl="";var isOpenBak=false;var chatList=new Array();var websocketServer=null;var pollingSendTimeExpire=0;var videoEnd={isWebcastClosed:false,isVideoEnd:false,isVideoWaiting:false};var wsExceptionFlag=false;var POLLING_INTERVAL_TIME=MAX_POLLING_INTERVAL_TIME;var MAX_POLLING_INTERVAL_TIME=10000;var pollingWebsocketClosed=false;var socketOpen=false;var pollingObject={sendNum:0,isWebsocket:true,startIntervalTime:null,intervalNum:0};var lockedPolling=false;var closeKeepLive=false;var resetSession=false;var hasSendPlay=false;var keepliveurl;var playingUrl;var sendUrl;var closedUrl;var resetInittimeUrl;var keepliveCmd;var playingCmd;var sendCmd;var closedCmd;var resetInittimeCmd;var isCouldPlaying=false;var unplayMediaUrl;var playMediaUrl;var lowvideoUrl;var annoXmlUrl="";var currentStream="-1";var videoUrl;var audioUrl;var iosVersion=0;var docPrefix;var backcdnUrl="";var nowPlayId=null;var audio_is_exit=false;var sessionInvalid=false;var liushow=false;var videoStatus;var c_failover=false;var isOpenResult=false;var isSupport=true;var failover=false;var isWebsocket=false;var android="";var connectsvr;var topsvr="";var lasttimestamp=-1;var isSelect=false;var closeTipNextFunction;var VISITALB_INTERVAL_TIME=10000;var ALBTimeoutResultObj;var ALBTimeoutObj;var VISITALB_BAK_INTERVAL_TIME=10000;var c_alb="";var visitALBCount=0;var isVisitALB=false;var visitScheme="http://";var c_confpassword;var c_confname;var c_confid;var c_siteid;var c_servicetype;var c_userid;var c_username;var c_userappdata="";var c_idc;var c_ipowner;var hide;var c_mainidc;var connectALBSvr;var connectBakALBSvr="";var isNeedVisitALB;var optimization;var c_responsetype="json";var c_ping_failover=false;var c_gcDomain;var c_gcPort;var c_idcArray;var taskObj;var gstrue=c_userappdata!=undefined&&c_userappdata!=""&&c_userappdata!=null;var stream;var channel=null;var wxx_ws="";var wxx_api="";var initFlag=false;var CardSurvey={};var CardAndSurveyResult={};var submitInterval=0;var tipObj={authorized:"License 不足",unopen:"直播未开始",open:"已经开始直播请点击！",ended:"直播已经结束！",pause:"直播即将进入暂停状态！",resume:"直播即将重新开始播放！",report:"当前帐号正在登录该直播，请确认后重新登录！"};var pauseOutId;var intervalTaskId;var pauseFlag=false;var isPlayEnd=false;var isFirstCanPlay=true;var openPolling;var wgid=null;var expflag=true;var refreshflag=false;var pollingWebsocketClosed=false;var wordsFilterApi="";var idcArray;var Gensee_STATUS_USER_LINE=null;var Gensee_VER;var bindPlayingFlag=false;var closeFun=function(){};var c_subject;var count=0;var playAudioUrl;var hisAnnoArray=new Array();var media={refresh:function(){if(!tool.checkObjectIsNull(websocketServer)){if(websocketServer.close){websocketServer.close()}websocketServer=null}if(wgid){GS.clearChannel()}pollingObject.startIntervalTime=0;openPolling=false;initFlag=false;hasSendPlay=false;clearInterval(timeoutObj);if(!tool.checkObjectIsNull(ALBTimeoutResultObj)){clearTimeout(ALBTimeoutResultObj)}if(!tool.checkObjectIsNull(ALBTimeoutObj)){clearTimeout(ALBTimeoutObj)}pollingDealTime=0;visitALBCount=0;isVisitALB=false;expflag=false;refreshflag=true;wsExceptionFlag=false;c_failover=false;isAreadyTip_Authorized=false;Gensee_VIDEO_STATUS_CMD=null;isAreadyTip_Unopen=false;isAreadyTip_Unopen=false;isAreadyTip_Open=false;isAreadyTip_End=false;isAreadyTip_Ejectdup=false;isAreadyTip_Pause=false;Gensee_Statu_default.isFilterQuestion=false;Gensee_Statu_default.isWantToUpgrade=false;Gensee_Statu_default.isFocus=true;Gensee_Statu_default.isMute=false;Gensee_Statu_default.isAudioInviting=false;Gensee_Statu_default.isAudioChatting=false;Gensee_Status_QA=true;cdnEnabled=false;isOpenBak=false;videoEnd={isWebcastClosed:false,isVideoEnd:false,isVideoWaiting:false};pollingWebsocketClosed=false;socketOpen=false;pollingObject={sendNum:0,isWebsocket:true,startIntervalTime:null,intervalNum:0};lockedPolling=false;closeKeepLive=false;resetSession=false;isCouldPlaying=false;audio_is_exit=false;sessionInvalid=false;liushow=false;isOpenResult=false;isSupport=true;failover=false;isWebsocket=false;isSelect=false;c_ping_failover=false;pauseFlag=false;isPlayEnd=false;isFirstCanPlay=true;currentStream="-1";Gensee_STATUS_USER_LIST=null;Gensee_STATUS_USER_LINE=null;Gensee_Now_Doc_Url_SDK=null;c_idc="";c_ipowner="";bindPlayingFlag=false;if(closedUrl){media.sendLeaveInfo()}},init:function(c,a){channel=app.globalData.channel;openPolling=true;wgid=channel.id;isVisitALB=false;expflag=true;refreshflag=false;var d={};if(tool.checkObjectIsNull(c.site)){d.api="init";d.param=c.site;d.explain="Parameter site miss";d.type=2}if(tool.checkObjectIsNull(c.ownerid)){d.api="init";d.param=c.ownerid;d.explain="Parameter ownerid miss";d.type=2}if(tool.checkObjectIsNull(c.authcode)){d.api="init";d.param=c.authcode;d.explain="Parameter authcode miss";d.type=2}if(tool.checkObjectIsNull(c.uid)){c.uid=""}if(tool.checkObjectIsNull(c.uname)){c.uname=""}if(tool.checkObjectIsNull(c.encodetype)){c.encodetype=""}if(tool.checkObjectIsNull(c.password)){c.password=""}if(tool.checkObjectIsNull(c.stream)){c.stream=""}if(tool.checkObjectIsNull(c.ownerid)){c.ownerid=""}if(tool.checkObjectIsNull(c.ctx)){c.ctx="webcast"}if(tool.checkObjectIsNull(c.authcode)){c.authcode=""}if(tool.checkObjectIsNull(c.istest)){c.istest=false}var b;if(!c.istest){b="https://"}else{b="http://"}if("training"===c.ctx){b=b+c.site+"/sdk/site/sdk/tra/wxconfig";c_servicetype=1}else{b=b+c.site+"/sdk/site/sdk/wxconfig";c_servicetype=0}b=b+"?ownerid="+c.ownerid+"&authcode="+c.authcode+"&uid="+c.uid+"&uname="+c.uname+"&encodetype="+c.encodetype+"&password="+c.password+"&stream="+c.stream+"&istest="+c.istest;console.log("init url:"+b);wx.request({url:b,header:{"content-type":"application/json","cache-control":"no-cache"},success:function(g){var h=g.data;if("success"==h.type){initFlag=true;c_confid=c.ownerid;c_userid=h.userId;c_username=h.uname;c_siteid=h.siteid;c_idc=h.idc;c_ipowner=h.ipowner;c_mainidc=h.mainidc;connectALBSvr=h.connectALBSvr;connectBakALBSvr=h.connectBakALBSvr;isNeedVisitALB=h.needVisitALB;optimization=h.optimization;c_gcDomain=h.gcDomain;c_gcPort=h.gcPort;c_idcArray=h.array;idcArray=new Array();for(var f=0;f<c_idcArray.length;f++){if(c_idcArray[f].pingUrl!=null&&c_idcArray[f].pingUrl!=""){idcArray.push({id:c_idcArray[f].id,code:c_idcArray[f].code,supported:c_idcArray[f].supported,name:c_idcArray[f].name,mainIdc:c_idcArray[f].mainIdc,selected:false,description:c_idcArray[f].description})}}videoStatus=h.videoStatus;c_confname=encodeURIComponent(h.confname);c_subject=h.confname;c_confpassword=h.confpassword;stream=h.stream;submitInterval=h.submitInterval;docPrefix=h.docPrefix;wordsFilterApi=h.wordsFilterApi;if(!c.istest){wxx_api=h.wxx_api;wxx_ws=h.wxx_ws}if(h.sslSupport){connectALBSvr=wxx_api+h.connectALBSvr.split(":")[0];connectBakALBSvr=wxx_api+h.connectBakALBSvr;visitScheme="https://"}ALBurl=visitScheme+connectALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?";if(connectBakALBSvr!=""){ALBBakUrl=visitScheme+connectBakALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?";isOpenBak=true}if(optimization){ALBurl=visitScheme+connectALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?";if(isOpenBak){ALBBakUrl=visitScheme+connectBakALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?"}}a.call(undefined,{"userid":c_userid,"channel":channel});var e=["submitChat","submitQuestion","submitVote","submitChatTo","submitRollcall","submitNetChoice","requireNetSettings","onPublicChat","onPriChat"];for(var f=0;f<e.length;f++){GS_proxy.bind(e[f])}taskObj=new task({executedImmediately:h.realTimeHlsEnabled,hTasks:[]});GS_proxy.send("onDataReady",{"minInterval":submitInterval});taskObj.addTaskFunction(Gensee_SDK_Task_PPT_MODULE,function(i){GS_proxy.send("onDocChange",i)},null);taskObj.addTaskFunction(Gensee_SDK_Task_ANNOTATION_SDK,function(i){GS_proxy.send("onAnnotation",i)},null);taskObj.addTaskFunction("annoFirst",function(i){GS_proxy.send("onInitAnno",i)},null);media.visitALB()}else{d.api="init";d.param=h;d.explain="Background check is not passed:"+JSON.stringify(h)+"-----type:"+h.type+"-----"+"desc:"+h.desc;d.type=1;if(!tool.checkObjectIsNull(d)){GS_proxy.send("onAPIError",d)}}},fail:function(e){d.api="init";d.param="site:"+c.site;d.explain="fail:"+e.errMsg;d.type=1;if(!tool.checkObjectIsNull(d)){GS_proxy.send("onAPIError",d)}}})},getIDCArray:function(){var b=new Array();if(isNeedVisitALB!=true){return b}for(var a=0;a<idcArray.length;a++){if(idcArray[a].mainIdc!="true"){var c={};c.selected=c_idc==idcArray[a].code?true:false;c.label=idcArray[a].description;b.push(c)}}return b},visitALB:function(){if(!tool.checkObjectIsNull(ALBurl)&&visitScheme=="https://"&&ALBurl.indexOf("sslsupport = true")==-1){ALBurl=ALBurl.replace("http://",visitScheme);ALBurl=ALBurl.replace("callback=?","sslsupport=true")+"&callback=?"}if(!tool.checkObjectIsNull(ALBBakUrl)&&visitScheme=="https://"&&ALBBakUrl.indexOf("sslsupport = true")==-1){ALBBakUrl=ALBBakUrl.replace("http://",visitScheme);ALBBakUrl=ALBBakUrl.replace("callback=?","sslsupport=true")+"&callback=?"}if(!tool.checkObjectIsNull(ALBurl)&&ALBurl.indexOf("hls=true")<0){ALBurl=ALBurl.replace("callback=?","hls=true")+"&callback=?"}if(!tool.checkObjectIsNull(ALBBakUrl)&&ALBBakUrl.indexOf("hls=true")<0){ALBBakUrl=ALBBakUrl.replace("callback=?","hls=true")+"&callback=?"}if(isNeedVisitALB!=true){media.ALBNextFn({connectsvr:c_gcDomain,topsvr:c_gcDomain+":"+c_gcPort})}else{if(!isVisitALB){if(visitALBCount<3){if(tool.checkObjectIsNull(ALBurl)){console.log("[visitALB]The ALBurl is undefined.")}else{console.log("[visitALB] the url is: "+ALBurl);visitALBCount++;media.getJSON(ALBurl);c_alb=visitScheme+connectBakALBSvr;ALBTimeoutObj=setTimeout(media.visitALB,VISITALB_BAK_INTERVAL_TIME)}console.log("ALBTimeoutObj"+ALBTimeoutObj)}else{console.log("checkObjectIsNull(ALBBakUrl):"+tool.checkObjectIsNull(ALBBakUrl)+";isOpenBak:"+isOpenBak+";result:"+(tool.checkObjectIsNull(ALBBakUrl)||!isOpenBak));if(tool.checkObjectIsNull(ALBBakUrl)||!isOpenBak){console.log("[ALBBakUrl]The ALBBakUrl is undefined,to  alburl,alburl:"+ALBurl);visitALBCount++;media.getJSON(ALBurl);visitALBCount=0;c_alb=visitScheme+connectALBSvr;ALBTimeoutObj=setTimeout(media.visitALB,VISITALB_BAK_INTERVAL_TIME)}else{console.log("[ALBBakUrl] the ALBBakUrl is: "+ALBBakUrl);visitALBCount++;media.getJSON(ALBBakUrl);visitALBCount=0;c_alb=visitScheme+connectBakALBSvr;ALBTimeoutObj=setTimeout(media.visitALB,VISITALB_BAK_INTERVAL_TIME)}}}}},pingresult:function(a){console.log("pingresultpingresult:"+a);if(!tool.checkObjectIsNull(ALBTimeoutObj)){clearTimeout(ALBTimeoutObj)}if(!tool.checkObjectIsNull(ALBTimeoutResultObj)){console.log("[pingresult]The ALBTimeoutResultObj:"+ALBTimeoutResultObj);clearTimeout(ALBTimeoutResultObj)}if(isVisitALB){console.log("[pingresult]Visit ALB already back is success.");return}visitALBCount--;console.log("[pingresult]Visit ALB success.");var b={};if(tool.checkObjectIsNull(a)){b.result="-1"}else{b=a;console.log(b.connectsvr)}if(b.result=="-1"){console.log("[pingresult]Return the results no data")}else{if(b.result=="2"||b.result=="4"){console.log("[pingresult]LAB connection failure, the reason is "+b.result);ALBTimeoutResultObj=setTimeout(media.visitALB,VISITALB_INTERVAL_TIME);console.log("[pingresult]LAB connection failure, the reason is "+b.result);ALBTimeoutResultObj=setTimeout(media.visitALB,VISITALB_INTERVAL_TIME)}else{if(b.result=="5"){console.log("[pingresult]LAB connection failure, the reason is "+b.result);media.jumpTipInfo(JUMPTYPE_NOT_ENOUGH_AUTHORIZED);closeTipNextFunction=function(){}}else{if(b.result=="3"||b.result=="6"){console.log("[pingresult]LAB connection failure, the reason is "+b.result);if(isAreadyTip_Unopen){ALBTimeoutResultObj=setTimeout(media.visitALB,VISITALB_INTERVAL_TIME)}else{media.jumpTipInfo(JUMPTYPE_LIVE_UNOPEN);closeTipNextFunction=function(){};ALBTimeoutResultObj=setTimeout(media.visitALB,VISITALB_INTERVAL_TIME)}}else{if(b.result=="0"){isVisitALB=true;c_idc=b.idcid;isSelect=true;c_ipowner=b.ipowner;media.ALBNextFn(b)}}}}}},iosVersion:function(d){var c=d.split(" ");var a=0;if(c&&c.length>1){var e=c[1];var b=e.indexOf(".");if(b>0){a=e.substr(0,b);if(isNaN(a)){a=0}else{a=Number(a)}}}return a},ALBNextFn:function(b){lasttimestamp=-1;if(!tool.checkObjectIsNull(b.topsvr)){topsvr=b.topsvr}connectsvr=wxx_api+b.connectsvr;var a="";wx.getSystemInfo({success:function(e){a=e.model;if(a.toLowerCase().indexOf("iphone")>=0){iosVersion=media.iosVersion(e.system);android=false;a=24}else{android=true;a=23}}});var c=visitScheme+connectsvr+"/httpstreamcmd/open/"+c_confid+"?servicetype="+c_servicetype+"&topsvr="+topsvr+"&userid="+c_userid+"&siteid="+c_siteid+"&username="+encodeURIComponent(c_username)+"&failover="+failover+"&jointype="+a;var g="open/"+c_confid+"?servicetype="+c_servicetype+"&topsvr="+topsvr+"&userid="+c_userid+"&siteid="+c_siteid+"&username="+encodeURIComponent(c_username)+"&failover="+c_failover+"&jointype="+a;if(b.forcehttp&&wxx_api==""){cdnUrl=b.cdn1;backcdnUrl=b.cdn2;if((cdnUrl!=undefined&&tool.trim(cdnUrl)!="")||(backcdnUrl!=undefined&&tool.trim(backcdnUrl)!="")){g+="&cdn=true";c+="&cdn=true";cdnEnabled=true}}g+="&callback=?";c+="&callback=?";if(wsExceptionFlag){media.visitWebUrl(c)}else{try{var d={};d.path="gensee_websocket";if(!tool.checkObjectIsNull(websocketServer)){if(websocketServer.close){websocketServer.close()}}if(visitScheme=="https://"){d.connect="wss://"+connectsvr;d.port="443"}else{d.connect="ws://"+connectsvr;d.port="80"}if(wxx_ws!=""&&wxx_ws!=wxx_api){d.connect=d.connect.replace(wxx_api,wxx_ws)}websocketServer=wx.connectSocket({url:d.connect+":"+d.port+"/gensee_websocket"});websocketServer.onOpen(function(){socketOpen=true;console.log("WebSocket连接已打开！");isWebsocket=true;clearTimeout(ALBTimeoutObj);clearTimeout(ALBTimeoutResultObj);clearInterval(timeoutObj);setTimeout(function(){if(!isOpenResult){console.log("[websocket]:websock is not accept message");isSupport=false;if(!tool.checkObjectIsNull(websocketServer)){if(websocketServer.close){websocketServer.close()}}}},10000);websocketServer.send({data:g,success:function(){console.log("success");return true},fail:function(){console.log("fail")}})});websocketServer.onMessage(function(h){console.log("收到服务器信息："+h.data);try{media.evalstr(h.data)}catch(i){console.log("deal data is exception,"+i)}});closeFun=function(){clearInterval(timeoutObj);pollingDealTime=0;isWebsocket=false;socketOpen=false;media.expire()};websocketServer.onClose(function(e){console.log("WebSocket 已关闭！:"+JSON.stringify(e));websocketServer=null;closeFun()});websocketServer.onError(function(e){console.log("WebSocket连接打开失败，请检查！："+JSON.stringify(e));wsExceptionFlag=true})}catch(f){console.log(f);media.visitWebUrl(c)}}},visitWebUrl:function(a){if(tool.checkObjectIsNull(a)){console.log("[visitWebUrl] the url is undefined.")}else{console.log("[visitWebUrl] the url is: "+a);media.getJSON(a)}},joinresult:function(a){isOpenResult=true;console.log("[joinresult]the callback is success.");if(tool.checkObjectIsNull(a)){console.log("[joinresult] the data is undefined.")}else{if(a.result=="0"){c_ping_failover="true";c_failover="true";console.log("6执行joinresult "+JSON.stringify(a));if(videoStatus=="2"){console.log("61执行joinresult "+JSON.stringify(a));media.timeoutDeal(a)}else{setTimeout(function(){media.timeoutDeal(a)},10000)}}else{if(a.result=="1"){websocketServer.onError(function(b){clearInterval(timeoutObj)});console.log("[[joinresult connection alb]]Join in webcast is fail,the reason is "+a.result+";to connection alb.");media.jumpTipInfo(JUMPTYPE_NOT_ENOUGH_AUTHORIZED)}else{if(a.result=="2"){console.log("[[joinresult connection alb]]Join in webcast is fail,the reason is "+a.result+";to connection alb.");media.jumpTipInfo(JUMPTYPE_TIP_REPORT_LONGIN)}else{if(a.result=="3"){console.log("subserver alb no connect"+a.result);media.jumpTipInfo("lock_ip")}else{if(a.result=="4"){console.log("subserver alb no connect"+a.result);media.expire()}else{console.log("[joinresult]Join in webcast is fail,the reason is "+a.result);media.jumpTipInfo(JUMPTYPE_TIP_NOT_ENOUGH)}}}}}}},timeoutDeal:function(a){if(c_failover){try{GS_proxy.send("onAnnoClear",{})}catch(b){console.log(b.message)}}console.log("7执行timeoutDeal "+JSON.stringify(a));console.log("[joinresult]Join in webcast is success:"+JSON.stringify(a));SESSIONID=a.sessionid;if(!tool.checkObjectIsNull(a.lowvideourl)&&a.lowvideourl!=""){liushow=true}media.urlCdnDetail(a.streamurl,a.audioonlyurl,a.lowvideourl);if(sessionInvalid){console.log("[joinresult]the sessionInvalid is true");sessionInvalid=false;if(!tool.checkObjectIsNull(a.audioonlyurl)){audio_is_exit=true}media.videoFn(videoUrl,lowvideoUrl,audioUrl);media.audioFn(videoUrl,lowvideoUrl,audioUrl)}else{media.audioFn(videoUrl,lowvideoUrl,audioUrl);media.videoFn(videoUrl,lowvideoUrl,audioUrl)}media.joinwebcastNextFn(a)},videoFn:function(b,d,a){console.log("5执行videoFn "+b);if(currentStream=="-1"){currentStream=stream;var c={};c.target="";c.option="multistream";c.enable=liushow;GS_proxy.send("onSetting",c)}if(currentStream=="0"&&liushow){playMediaUrl=lowvideoUrl}else{playMediaUrl=videoUrl}unplayMediaUrl=audioUrl;console.log("[videoFn] The play url :"+playMediaUrl+";videoUrl="+videoUrl+";lowvideoUrl="+lowvideoUrl+";audioUrl="+audioUrl);if(cdnEnabled){if(media.urlChangeDetail()){if(currentStream=="0"&&liushow){playMediaUrl=lowvideoUrl}else{playMediaUrl=videoUrl}unplayMediaUrl=audioUrl;console.log("cdn change:"+playMediaUrl)}}GS_proxy.send("onVideoUrl",playMediaUrl);isCouldPlaying=true;media.jumpTipInfo(JUMPTYPE_TIP_COULD_OPEN);closeTipNextFunction=function(){}},audioFn:function(b,c,a){playAudioUrl=audioUrl;unplayMediaUrl=b;console.log("[audioFn] The audio url :"+audioUrl+";playAudioUrl="+playAudioUrl+";audio="+unplayMediaUrl);if(cdnEnabled){if(media.urlChangeDetail()){playAudioUrl=audioUrl;unplayMediaUrl=videoUrl;console.log("cdn change:"+playAudioUrl)}}GS_proxy.send("onAudioUrl",playAudioUrl);isCouldPlaying=true;media.jumpTipInfo(JUMPTYPE_TIP_COULD_OPEN);closeTipNextFunction=function(){}},urlChangeDetail:function(){console.log("url change before:"+videoUrl+lowvideoUrl+audioUrl);var b=true;if(cdnUrl!=undefined&&tool.trim(cdnUrl)!=""&&cdnUrl.indexOf(".m3u8")<0&&videoUrl.indexOf(cdnUrl.replace("https://","").replace("http://","")+"/")>=0&&backcdnUrl!=undefined&&tool.trim(backcdnUrl)!=""){var c=cdnUrl.replace("https://","").replace("http://","");var a=backcdnUrl.replace("https://","").replace("http://","");videoUrl=videoUrl.replace(c+"/",a+"/");if(lowvideoUrl!=undefined&&tool.trim(lowvideoUrl)!=""){lowvideoUrl=lowvideoUrl.replace(c+"/",a+"/")}audioUrl=audioUrl.replace(c+"/",a+"/");visitUrl=visitUrl.replace(c+"/",a+"/")}else{b=false}if(b){console.log("url change after:"+videoUrl+lowvideoUrl+audioUrl)}return b},urlFileName:function(b){if(!tool.checkObjectIsNull(b)&&tool.trim(b)!=""){var a=b.lastIndexOf("/");if(a>-1){return b.substring(a+1)}else{return b}}else{return""}},urlCdnDetail:function(f,g,h){var b;var e;if(!tool.checkObjectIsNull(topsvr)){b=topsvr.split(":")}if(!tool.checkObjectIsNull(b)){e=b[0]}var d=media.urlFileName(f);var a=media.urlFileName(g);var c=media.urlFileName(h);if(cdnEnabled){if((cdnUrl!=undefined&&tool.trim(cdnUrl)!="")){if(cdnUrl.indexOf(".m3u8")>0){if(visitScheme=="https://"){visitUrl="https://"}else{visitUrl="http://"}visitUrl+=connectsvr+"/httpstream/"+c_confid+"/";annoXmlUrl=visitUrl+"anno.xml?t="+new Date().getTime();d=urlFileName(cdnUrl);if(cdnUrl.indexOf("http://")<0&&cdnUrl.indexOf("https://")<0){videoUrl=visitScheme+cdnUrl}else{if(cdnUrl.indexOf("http://")==0&&visitScheme!="http://"){videoUrl=cdnUrl.replace("http://",visitScheme)}else{if(cdnUrl.indexOf("https://")==0&&visitScheme!="https://"){videoUrl=cdnUrl.replace("https://",visitScheme)}else{videoUrl=cdnUrl}}}audioUrl=videoUrl.replace(d,a);if(c!=""){lowvideoUrl=videoUrl.replace(d,c)}}else{if(cdnUrl.indexOf("http://")<0&&cdnUrl.indexOf("https://")<0){visitUrl=visitScheme+cdnUrl}else{if(cdnUrl.indexOf("http://")==0&&visitScheme!="http://"){visitUrl=cdnUrl.replace("http://",visitScheme)}else{if(cdnUrl.indexOf("https://")==0&&visitScheme!="https://"){visitUrl=cdnUrl.replace("https://",visitScheme)}else{visitUrl=cdnUrl}}}visitUrl+="/"+e+"/httpstream/"+c_confid+"/";videoUrl=visitUrl+d;audioUrl=visitUrl+a;if(c!=""){lowvideoUrl=visitUrl+c}annoXmlUrl=visitUrl+"anno.xml"}}else{if((backcdnUrl!=undefined&&backcdnUrl.trim()!="")){if(backcdnUrl.indexOf("http://")<0&&backcdnUrl.indexOf("https://")<0){visitUrl=visitScheme+cdnUrl}else{if(backcdnUrl.indexOf("http://")==0&&visitScheme!="http://"){visitUrl=backcdnUrl.replace("http://",visitScheme)}else{if(backcdnUrl.indexOf("https://")==0&&visitScheme!="https://"){visitUrl=backcdnUrl.replace("https://",visitScheme)}else{visitUrl=backcdnUrl}}}visitUrl+="/"+e+"/httpstream/"+c_confid+"/";videoUrl=visitUrl+d;audioUrl=visitUrl+a;if(c!=""){lowvideoUrl=visitUrl+c}annoXmlUrl=visitUrl+"anno.xml"}}}else{if(visitScheme=="https://"){visitUrl="https://"}else{visitUrl="http://"}visitUrl+=connectsvr+"/httpstream/"+c_confid+"/";videoUrl=visitUrl+d+"?sessionid="+SESSIONID+"&t="+new Date().getTime();audioUrl=visitUrl+a+"?sessionid="+SESSIONID+"&t="+new Date().getTime();if(c!=""){lowvideoUrl=visitUrl+c+"?sessionid="+SESSIONID+"&t="+new Date().getTime()}annoXmlUrl=visitUrl+"anno.xml?t="+new Date().getTime();if(iosVersion>=11&&docPrefix!=undefined&&tool.trim(docPrefix)!=""){visitUrl=visitScheme+docPrefix.replace("http://","").replace("https://","")+"/"+e+"/httpstream/"+c_confid+"/"}}},onSocketMessage:function(b){console.log("[websocket send]message:"+b);var a=false;if(!tool.checkObjectIsNull(websocketServer)){if(websocketServer.readyState==socketOpen){console.log("type=websocket:[send The message]"+b);websocketServer.send({data:b});a=true}}console.log("[websocket send]result:"+a);return a},joinwebcastNextFn:function(a){GS_proxy.send("onStart",{});GS_proxy.send("onTitle",{"content":c_subject});console.log("[joinwebcastNextFn]The video is already start play.");keepliveurl=visitScheme+connectsvr+"/httpstreamcmd/keepalive/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random();playingUrl=visitScheme+connectsvr+"/httpstreamcmd/play/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";sendUrl=visitScheme+connectsvr+"/httpstreamcmd/send/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random();closedUrl=visitScheme+connectsvr+"/httpstreamcmd/close/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";resetInittimeUrl=visitScheme+connectsvr+"/httpstreamcmd/resetinittime/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";keepliveCmd="keepalive/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random();playingCmd="play/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";sendCmd="send/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random();closedCmd="close/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";resetInittimeCmd="resetinittime/"+c_confid+"?sessionid="+a.sessionid+"&t="+Math.random()+"&callback=?";closeKeepLive=false;media.toldPlay();if(resetSession){hasSendPlay=false;media.toldPlay();resetSession=false}media.polling(keepliveurl,true);media.getAnnoHis()},polling:function(b,a){setTimeout(function(){if(!closeKeepLive){console.log("[polling IntervalTime]:"+new Date().getTime()+";"+pollingObject.intervalNum);pollingObject.intervalNum++;media.sendKeepLive(b,a)}else{console.log("[polling]The closeKeepLive is true.")}},0)},getAnnoHis:function(){if(annoXmlUrl.length>0){media.getXmlData(annoXmlUrl)}},getXmlData:function(a){wx.request({url:a,dateType:"xml",success:function(b){console.log("[getXmlData] Ajax is success.");var c=analysis.parseXml(b.data);console.log("[getXmlData] The xml analytical result:"+c);analysis.analysisHisAnno(c)},error:function(){console.log("[getXmlData]The xmlUrl:"+a+" is error.")}})},getJsonP:function(a){console.log("getJsonP url:"+a);wx.request({type:"get",async:true,url:a,dataType:"json",timeout:15000,success:function(b){console.log("getjsonp data success:"+JSON.stringify(b));if(!tool.checkObjectIsNull(b.data)&&b.data!=""){if(b.data.indexOf("expire")>-1){c=b.data.replace("expire(","").replace(")","").trim();console.log("getJaonP:"+c);media.expire()}else{if(b.data.indexOf("metadata")>-1){var c=b.data;c=c.replace("metadata(","").replace(")","").trim();media.metadata(c)}}}else{media.sendKeepLive(pollingObject.url,pollingObject.isPolling)}},fail:function(b){console.log("getjsonp fail:"+JSON.stringify(b));media.sendKeepLive(pollingObject.url,pollingObject.isPolling);pollingDealTime+=1}})},sendKeepLive:function(c,b){lockedPolling=true;var e=c;var d=app.globalData.currentTime-startPlayCurrentTime;pollingObject.startIntervalTime=new Date().getTime();if(c.indexOf("?")>0){c=c+"&lasttimestamp="+lasttimestamp+"&playtime="+d+"&waitnum="+1+"&sign="+pollingObject.startIntervalTime+"&callback=?"}else{c=c+"?lasttimestamp="+lasttimestamp+"&playtime="+d+"&waitnum="+1+"&sign="+pollingObject.startIntervalTime+"&callback=?"}console.log("[polling]the currentTime:"+d+";waitnum:"+waitnum);if(tool.checkObjectIsNull(c)){console.log("[polling]The url is undefined.")}else{console.log("The send websocket"+(!tool.checkObjectIsNull(websocketServer)&&socketOpen));if(!tool.checkObjectIsNull(websocketServer)&&socketOpen){if(!pollingWebsocketClosed){closeFun=function(){closeKeepLive=false;media.sendKeepLive(e,b)};pollingWebsocketClosed=true}if(!media.onSocketMessage(keepliveCmd)){console.log("[polling]The url is :"+c+",the interval time:"+POLLING_INTERVAL_TIME);pollingObject.sendNum=pollingObject.sendNum+1;console.log("[pollingObject.sendNum]"+pollingObject.sendNum);pollingObject.isWebsocket=false;console.log("[send time]"+new Date().getTime());media.getJsonP(c)}else{closeKeepLive=true;pollingObject.isWebsocket=true;pollingDealTime=0;console.log("send websocket cmd")}}else{if(isWebsocket&&!socketOpen){pollingObject.isWebsocket=false;wsExceptionFlag=true;media.expire()}else{pollingObject.sendNum=pollingObject.sendNum+1;console.log("[pollingObject.sendNum]"+pollingObject.sendNum);pollingObject.isWebsocket=false;console.log("[send time]"+new Date().getTime());media.getJsonP(c)}}var a=false;if(pollingDealTime==0){pollingDealTime=new Date().getTime()}else{if(pollingDealTime>10){a=true}}if(a){console.log("[polling] the gsonp is not result");clearInterval(timeoutObj);pollingDealTime=0;media.expire()}}pollingObject.url=e;pollingObject.isPolling=b;lockedPolling=false},expire:function(){if(expflag){if(!videoEnd.isWebcastClosed&&!isAreadyTip_Ejectdup&&!isAreadyTip_End){clearInterval(timeoutObj);if(visitScheme=="http://"){ALBurl="http://"+connectALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?"}else{ALBurl="https://"+connectALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&sslsupport=true"+"&callback=?"}if(ALBurl.indexOf("hls=true")<0){ALBurl=ALBurl.replace("callback=?","hls=true")+"&callback=?"}if(isOpenBak){if(visitScheme=="http://"){ALBBakUrl="http://"+connectBakALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?"}else{ALBBakUrl="https://"+connectBakALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+c_idc+"&ipowner="+c_ipowner+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&sslsupport=true"+"&callback=?"}if(ALBBakUrl.indexOf("hls=true")<0){ALBBakUrl=ALBBakUrl.replace("callback=?","hls=true")+"&callback=?"}}if(!tool.checkObjectIsNull(websocketServer)&&socketOpen){console.log("[websocket expire]");closeFun=function(){console.log("[expire]The closed webserver.");closeKeepLive=true;resetSession=true;wsExceptionFlag=false;waitnum=0;sessionInvalid=true;openPolling=false;if(!tool.checkObjectIsNull(isVisitALB)&&!tool.checkObjectIsNull(visitALBCount)){isVisitALB=false;visitALBCount--}media.visitALB()};if(socketOpen){if(!tool.checkObjectIsNull(websocketServer)){if(websocketServer.close){websocketServer.close();websocketServer=null}}}}else{closeKeepLive=true;console.log("[expire]The closeKeepLive is seted true.");resetSession=true;waitnum=0;sessionInvalid=true;pollingSendTimeExpire=new Date().getTime();console.log("[expire]pollingSendTimeExpire:"+pollingSendTimeExpire);if(!tool.checkObjectIsNull(isVisitALB)&&!tool.checkObjectIsNull(visitALBCount)){isVisitALB=false;visitALBCount--}taskObj.executeAllTask();media.visitALB()}}}},dealChat:function(){if(gstrue&&chatList.length>0){var c=new Date().getTime();var f=new Array();for(var b=0;b<chatList.length;b++){var d=chatList[b].timestamp;if(chatList[b].hasInfo||c-d>15000){var g=chatList[b].chats;for(var a=0;a<g.length;a++){var e=g[a];e.inittimestamp=inittimestamp;if(e.userdata==undefined&&userdatas[e.senderUid]!=undefined){e.userdata=userdatas[e.senderUid]}f.push(e);chatList.splice(0,1)}b--}else{break}}if(f.length>0){media.emsDealFunction(f)}}},metadata:function(b){var b=JSON.parse(b);if(!pollingObject.isWebsocket){if(!tool.checkObjectIsNull(b.sign)){if(b.sign-pollingSendTimeExpire<=0){console.log("[metadata] the this polling,before expire.resultObj.sign:"+b.sign+";pollingSendTimeExpire:"+pollingSendTimeExpire);return}}}if(gstrue){media.dealChat()}console.log("[start deal time]resultObj.sign："+b.sign+";pollingSendTimeExpire:"+pollingSendTimeExpire);console.log("[start deal time]"+new Date().getTime());console.log("[metadata]The metadata is executed,content:"+b);console.log("[pollingObject.sendNum]"+pollingObject.sendNum);if(!pollingObject.isWebsocket){pollingObject.sendNum=pollingObject.sendNum-1;console.log("[clear polling]");console.log("[timeoutnum_add]"+new Date()+";"+pollingObject.sendNum)}pollingDealTime=0;if(!tool.checkObjectIsNull(b)){if(b.lasttimestamp!=undefined){lasttimestamp=b.lasttimestamp}var d=b.timestamp;if(!tool.checkObjectIsNull(b.inittimestamp)){inittimestamp=b.inittimestamp}console.log("[sendKeepLive liveDemandStartParamFn]"+b.vod);if(!tool.checkObjectIsNull(b.data)){for(var c=0;c<b.data.length;c++){var a=b.data[c];try{media.distributionFn(a)}catch(f){console.log("错误信息："+f)}}}}else{console.log("[metadata]The resultObj is undefined.")}console.log("[pollingObject.sendNum]:"+pollingObject.sendNum+"[pollingObject.intervalNum]"+pollingObject.intervalNum);console.log("[end deal time]"+new Date().getTime()+";"+(!pollingObject.isWebsocket));if(!pollingObject.isWebsocket&&openPolling){console.log("[sendKeepLive]pollingObject.startIntervalTime:"+pollingObject.startIntervalTime+";resultObj.sign:"+b.sign);if((pollingObject.startIntervalTime-0)==(b.sign-0)){media.sendKeepLive(pollingObject.url,pollingObject.isPolling)}}},distributionFn:function(a){console.log("[distributionFn]The type is :"+a.type);console.log("[data inittimestamp]"+inittimestamp);if(a.type=="document"){var e=analysis.analysisPpt(a.content);e.inittimestamp=inittimestamp;taskDeal.pptDealFunction(e)}else{if(a.type=="annotation"){var e=analysis.analysisAnno(a.content);e.inittimestamp=inittimestamp;taskDeal.annoDealFunction(e)}else{if(a.type=="qa"){var h=analysis.analysisQaType(a.content);if(h=="qa"){var e=analysis.analysisQa(a.content);e.inittimestamp=inittimestamp;media.qaDealFunction(e)}else{if(h=="qahistroy"){var e=analysis.analysisQaList(a.content);media.qaListDealFunction(e)}}}else{if(a.type=="vote"){var f=analysis.analysisVote(a.content);f.inittimestamp=inittimestamp;for(var g=0;g<f.contentArray.length;g++){var d=f.contentArray[g];var b=null;if(!(tool.checkObjectIsNull(d.timestamp)||(d.timestamp-0)<(f.inittimestamp-0))){b=d.timestamp-f.inittimestamp}GS_proxy.send("onVote",d)}for(var g=0;g<f.resultArray.length;g++){var d=f.resultArray[g];var b=null;if(!(tool.checkObjectIsNull(d.timestamp)||(d.timestamp-0)<(f.inittimestamp-0))){b=d.timestamp-f.inittimestamp}d.skip=undefined;GS_proxy.send("onVoteResult",d)}}else{if(a.type=="survery"){var e=analysis.analysisSurvey(a.content);e.inittimestamp=inittimestamp;GS_proxy.send("onSurvey",e)}else{if(a.type=="ems"){var e=analysis.analysisEms(a.content);e.inittimestamp=inittimestamp;media.emsDealFunction(e)}else{if(a.type=="lottery"){var e=media.lottery(a.content);e.inittimestamp=inittimestamp;media.lotteryDealFunction(e)}else{if(a.type=="videoparam"){var e=analysis.analysisVideoParam(a.content);e.inittimestamp=inittimestamp;GS_proxy.send("onVideoConfig",e)}else{if(a.type=="usernum"){var j=analysis.analysisUsernum(a.content);var e={};e.inittimestamp=inittimestamp;for(var g=0;g<j.length;g++){var c=j[g];if((c.num-0)>0){GS_proxy.send("onUserOnline",{count:c.num});if(Gensee_STATUS_USER_LINE==null||!Gensee_STATUS_USER_LINE){Gensee_STATUS_USER_LINE=true;GS_proxy.send("onSetting",{enable:true,target:"all",option:"onlineuser"})}}else{if(Gensee_STATUS_USER_LINE==null||Gensee_STATUS_USER_LINE){Gensee_STATUS_USER_LINE=false;GS_proxy.send("onSetting",{enable:false,target:"all",option:"onlineuser"})}}}}}}}}}}}}},qaListDealFunction:function(g){var c={};c.list=new Array();for(var b=0;b<g.list.length;b++){var e=g.list[b];var d=new Array();for(var a=0;a<g.list.length;a++){if(g.list[a].id==e.id){d.push(g.list[a]);g.list.splice(a,1);a--}}if(!d[d.length-1].remove){for(var f=0;f<d.length;f++){if(!d[f].remove){if(f==0){c.list.push(d[f])}else{if(d[f].answer!=""){c.list.push(d[f])}}}}}b--}GS_proxy.send("onQAList",c)},lottery:function(c){var a={};a.array=new Array();var d=analysis.parseXml(c);var b=d.documentElement;var h=b.getElementsByTagName("lottery");for(var e=0;e<h.length;e++){var f={};var g=h[e];f.cmd=analysis.getXmlNodeAttr(g,"cmd");f.timestamp=analysis.dealStartTime(analysis.getXmlNodeAttr(g,"timestamp"));f.info=analysis.getXmlNodeAttr(g,"info");a.array.push(f)}return a},evalstr:function(d){console.log("evalstr:"+d);var c=d.split("({");console.log(c);switch(c[0]){case"pingresult":var b=d.replace("pingresult(","").replace("})","}");console.log(b);var a=JSON.parse(b);media.pingresult(a);break;case"joinresult":var b=d.replace("joinresult(","").replace("})","}");var a=JSON.parse(b);media.joinresult(a);break;case"metadata":var b=d.replace("metadata(","").replace("})","}");media.metadata(b);break}},getJSON:function(a){wx.request({url:a,header:{"content-type":"application/json"},success:function(b){console.log("getJSON success:"+b.data);try{media.evalstr(b.data)}catch(c){console.log("deal data is exception,"+c)}},fail:function(b){console.log("getJSON fail:"+JSON.stringify(b))}})},lotteryDealFunction:function(d){var e=d.array;for(var c=0;c<e.length;c++){var b={};var a=e[c];if(a.cmd==Gensee_Lottery_Start){b.action="start"}else{if(a.cmd==Gensee_Lottery_End){b.action="stop"}else{if(a.cmd==Gensee_Lottery_Abort){b.action="abort"}}}b.user=a.info;GS_proxy.send("onLottery",b)}},qaDealFunction:function(f){var b=f.qaArray;for(a in b){var e=b[a];if(e.removed==true||e.removed=="true"){GS_proxy.send("onQARemove",{id:e.id});continue}else{e.cmd=undefined;e.publishtimestamp=undefined;GS_proxy.send("onQA",e);continue}}if(f.pushQaList){for(var a=0;a<f.pushQaList.length;a++){var c=f.pushQaList[a];var d=Gensee_Deal_Function.PUSH_QA;if(c.cmd=="cancelHighlight"){d=Gensee_Deal_Function.CANCEL_QA}if(c.cmd=="highlight"){d=Gensee_Deal_Function.ANSWER_QA}GS_proxy.send(d,{id:c.questionid})}}},emsDealFunction:function(d){console.log("[emsDealFunction]start");for(var e=0;e<d.length;e++){var k=d[e];var j="";var f="";if(k.type=="publicMsg"){j="onMessage";f={content:k.content}}else{if(k.type=="close"){f={};j="onStop";Gensee_VIDEO_STATUS_CMD="stop";media.jumpTipInfo(JUMPTYPE_TIP_VIDEO_END)}else{if(k.type=="pause"){f={};j="onPause";Gensee_VIDEO_STATUS_CMD="pause"}else{if(k.type=="ejectUser"||k.type=="ejectdup"){j="onKickOut";Gensee_VIDEO_STATUS_CMD="kickout";if(k.type=="ejectUser"){f={reason:"0"}}else{if(k.type=="ejectdup"){f={reason:"1"}}}media.jumpTipInfo(JUMPTYPE_TIP_REPORT_LONGIN)}else{if(k.type=="start"){f={};j="onStart"}else{if(k.type=="rollCall"){Gensee_ROLL_CALL_TYPE=null;j="onRollcall";if(k.timeout>=0){var a=new Date().getTime()+Math.random();a=Math.round(a*100000);f={timeout:k.timeout,id:a};Gensee_Roll_Call={timeout:k.timeout,id:a};Gensee_Roll_Call.deal=false;clearTimeout(Gensee_Roll_Call_Timeout);Gensee_Roll_Call_Timeout=setTimeout(function(){if(Gensee_Roll_Call!=null&&!Gensee_Roll_Call.deal){sendMessage.sendRollCall(3);Gensee_Roll_Call=null}},f.timeout*1000)}else{sendMessage.sendRollCall(3)}sendMessage.sendRollCall(1)}else{if(k.type=="rollCall2"){if(k.timeout>=0){Gensee_ROLL_CALL_TYPE="rollCall2";j="onRollcall";f={timeout:k.timeout,id:k.senderid};Gensee_Roll_Call={timeout:k.timeout,id:k.senderid};Gensee_Roll_Call.deal=false}else{continue}}else{if(k.type=="chat"){var b=k;b.type=undefined;GS_proxy.send("onPriChat",b);continue}else{if(k.type=="chat_all"){var b=k;b.type=undefined;chat.loadChat(b);continue}else{if(k.type=="chat_third"){var c={};var b=k;c.richtext=k.richtext;c.type=undefined;c.senderId=undefined;c.senderUid=undefined;c.role=undefined;var h="onThirdPartChat";GS_proxy.send(h,{content:c});continue}else{if(k.type=="muteChat"){f={};if(k.on==1){f.enable=false;sendMessage.sendFocus({isFilterQuestion:true})}else{if(k.on==0){f.enable=true;sendMessage.sendFocus({isFilterQuestion:false})}}f.type=undefined;f.target="self";f.option="question";j="onSetting";var g=f.enable;GS_proxy.send(j,{enable:g,target:"self",option:"chat"})}else{if(k.type=="qaenable"){f={};if(k.enable=="false"){Gensee_Status_QA=false;f.enable=false}else{if(k.enable=="true"){Gensee_Status_QA=true;f.enable=true}}f.type=undefined;f.target="all";f.option="question";j="onSetting"}else{if(k.type=="chatenable"){f={};if(k.enable=="false"){Gensee_Status_Chat=false;f.enable=false}else{if(k.enable=="true"){Gensee_Status_Chat=true;f.enable=true}}f.type=undefined;f.target="all";f.option="chat";j="onSetting"}else{if(k.type=="onRosterInfolist"){console.log("[onRosterInfolist]:"+k.list.length);if(k.list.length>0){GS_proxy.send("onUserList",{list:k.list})}if(k.joinList.length>0){GS_proxy.send("onUserJoin",{list:k.joinList})}if(k.leaveList.length>0){GS_proxy.send("onUserLeave",{list:k.leaveList})}if(k.updateList.length>0){GS_proxy.send("onUserUpdate",{list:k.updateList})}if(k.disabled){GS_proxy.send("onSetting",{enable:false,target:"all",option:"userlist"})}else{if(Gensee_STATUS_USER_LIST==null||!Gensee_STATUS_USER_LIST){GS_proxy.send("onSetting",{enable:true,target:"all",option:"userlist"})}}Gensee_STATUS_USER_LIST=!k.disabled;continue}else{if(k.type=="resume"){f={};j="onPlay";Gensee_VIDEO_STATUS_CMD="resume";console.log("[emsDealFunction]:resume:");isCouldTip_Resume=true;taskObj.executeAllTask();media.toldPlay()}else{if(k.type=="user.rostrum"){f={hostid:k.globaluserid};console.log("[onUserHost]:");if(Gensee_Asker_User_Id==null){if(f.hostid!="0"||(f.hostid-0)!=0){if(Gensee_UP_HOST==null){Gensee_UP_HOST=setTimeout(function(){Gensee_VIDEO_START_INIT=true;if(Gensee_VIDEO_START_CURRENT_TIME==null||app.globalData.currentTime<=Gensee_VIDEO_START_CURRENT_TIME){console.log("[resetvideo]is start:"+new Date()+";"+new Date().getTime());taskObj.executeAllTask()}else{console.log("[resetvideo]is null.")}},10000)}else{clearTimeout(Gensee_UP_HOST);taskObj.executeAllTask()}}}continue}else{if(k.type=="user.asker"){f={askerid:k.globaluserid};console.log("[onUserAsker]:");if(Gensee_Host_User_Id==null){if(f.askerid!="0"||(f.askerid-0)!=0){if(Gensee_UP_HOST==null){Gensee_UP_HOST=setTimeout(function(){Gensee_VIDEO_START_INIT=true;var i=getMediaObje();if(Gensee_VIDEO_START_CURRENT_TIME==null||app.globalData.currentTime<=Gensee_VIDEO_START_CURRENT_TIME){console.log("[resetvideo]is start:"+new Date()+";"+new Date().getTime());taskObj.executeAllTask()}else{console.log("[resetvideo]is null.")}},10000)}else{clearTimeout(Gensee_UP_HOST);taskObj.executeAllTask()}}}continue}else{if(k.type=="class.mode"){j="onClassMode";f={mode:k.mode}}else{if(k.type=="RoleStatus"){j="onRoleStatus";f={hostid:k.hostid,hostname:k.hostname,presid:k.presid,presname:k.presname}}else{if(k.type=="tip"){j="onRewardMessage";f={id:k.content.id,amount:k.content.amount,userid:k.content.userid,username:k.content.username}}else{if(k.type=="delchat"){j="onChatRemove";f={censorList:k.censorList}}else{continue}}}}}}}}}}}}}}}}}}}}}GS_proxy.send(j,f)}},toldPlay:function(){console.log("执行toldplay");if(initFlag){taskObj.start();console.log("[toldPlay] initFlag:"+initFlag);var a=playingUrl;if(Gensee_VIDEO_STATUS_CMD!="stop"&&Gensee_VIDEO_STATUS_CMD!="kickout"){if(!hasSendPlay){if(isCouldPlaying){if(tool.checkObjectIsNull(a)){console.log("[toldPlay]The url is undefined.");return false}else{if(websocketServer===undefined||!media.onSocketMessage(playingCmd)){console.log("send websocket is fail.");pollingObject.sendNum=pollingObject.sendNum+1;media.getJSON(a);console.log("[told play url]："+a)}else{toldPlayWebsocketCmd=true;console.log("send websocket toldPlay cmd")}hasSendPlay=true;return true}}else{console.log("[toldPlay] The video url is unload.");return false}}else{console.log("[toldPlay]To play video or audio");return true}}else{console.log("[toldPlay] fail the video is ended or the user is kickouted")}}else{console.log("media init fail")}},jumpTipInfo:function(a){if(a==JUMPTYPE_LIVE_UNOPEN&&(!isAreadyTip_Unopen)){GS_proxy.send("onStatus",{type:2,explain:tipObj.unopen});isAreadyTip_Unopen=true}else{if(a==JUMPTYPE_NOT_ENOUGH_AUTHORIZED&&(!isAreadyTip_Authorized)){GS_proxy.send("onStatus",{type:1,explain:tipObj.authorized});isAreadyTip_Authorized=true}else{if(a==JUMPTYPE_TIP_COULD_OPEN&&isAreadyTip_Unopen&&!isAreadyTip_Open){isAreadyTip_Open=true}else{if(a==JUMPTYPE_TIP_VIDEO_END&&!isAreadyTip_End&&!isAreadyTip_Ejectdup){media.closedAllInfo();isAreadyTip_End=true}else{if(a==JUMPTYPE_TIP_WEBCASRT_PAUSE){if(!isCouldTip_Resume){isAreadyTip_Pause=true;isCouldTip_Resume=true}}else{if(a==JUMPTYPE_TIP_WEBCASRT_RESUME&&isAreadyTip_Pause){isAreadyTip_Pause=false;isCouldTip_Resume=false}else{if(a==JUMPTYPE_TIP_REPORT_LONGIN){isAreadyTip_Ejectdup=true;media.closedAllInfo();media.sendLeaveInfo()}else{if(a=="lock_ip"){GS_proxy.send("onStatus",{type:8,explain:"该用户已被封，加入失败"})}}}}}}}}},closedAllInfo:function(){clearInterval(timeoutObj);if(!tool.checkObjectIsNull(websocketServer)){websocketServer.close({fail:function(a){console.log("closed"+a)}})}},pauseDetail:function(){taskObj.executeAllTask();intervalTaskId=setInterval(function(){taskObj.executeAllTask()},1000);pauseFlag=true},initBindPause:function(){Gensee_VIDEO_Status="pause";hasSendPlay=false;hasSendPlay=false;console.log("[initBindPause]The video is "+hasSendPlay);pauseObj.pauseTimeDate=new Date().getTime();pauseObj.pauseVideoTime=app.globalData.currentTime;pauseObj.isPause=true;pauseOutId=setTimeout(media.pauseDetail,10000)},resetInitTime:function(){try{var a=resetInittimeUrl;if(isPlayEnd){console.log("[the live is end]");return}if(isCouldPlaying){if(tool.checkObjectIsNull(a)){console.log("[toldPlay]The url is undefined.");return false}else{var b=resetInittimeCmd;if(websocketServer===null||!onSocketMessage(b)){console.log("send websocket is fail.");pollingObject.sendNum=pollingObject.sendNum+1;console.log("toldPlay url "+a);media.getJSON(a);taskObj.executeAllTask();console.log("[told resetInitTime url]："+resetInittimeUrl)}return true}}else{console.log("[toldPlay] The video url is unload.");return false}}catch(c){console.log("Throw the exception"+c);return false}},initBindPlay:function(){if(pauseOutId){clearTimeout(pauseOutId)}if(pauseFlag){if(intervalTaskId){clearInterval(intervalTaskId)}taskObj.executeAllTask();var b=playAudioUrl.indexOf("&t=")+3;if(b>2){playAudioUrl=playAudioUrl.substring(0,b)+new Date().getTime()}else{playAudioUrl=playAudioUrl}console.log("刷新playAudiourl-----------"+playAudioUrl);var c=playMediaUrl.indexOf("&t=")+3;if(c>2){playMediaUrl=playMediaUrl.substring(0,c)+new Date().getTime()}else{playMediaUrl=playMediaUrl}console.log("刷新playMediaUrl-----------"+playMediaUrl);GS_proxy.send("onVideoUrl",playMediaUrl);GS_proxy.send("onAudioUrl",playAudioUrl);var a=media.resetInitTime();console.log("刷新resetinittime-----------"+a);pauseFlag=false}},initBindEnded:function(){Gensee_VIDEO_Status="ended";console.log("[ended]videoEnd.isWebcastClosed is "+videoEnd.isWebcastClosed);if(videoEnd.isWebcastClosed){isPlayEnd=true;console.log("[ended]"+isPlayEnd);media.jumpTipInfo(JUMPTYPE_TIP_VIDEO_END);console.log("[ended]"+$("#"+nowPlayId).attr("src"));closeTipNextFunction=function(){}}else{videoEnd.isVideoEnd=true}},initBindWaiting:function(){console.log("[waiting]The waiting ");if(videoEnd.isWebcastClosed){media.jumpTipInfo(JUMPTYPE_TIP_VIDEO_END);closeTipNextFunction=function(){}}else{waitnum++;console.log("videoEnd.isVideoWaiting: "+videoEnd.isVideoWaiting);videoEnd.isVideoWaiting=true}},initBindPlaying:function(){console.log("initBindPlaying");if(!bindPlayingFlag&&Gensee_VIDEO_STATUS_CMD!="pause"){GS_proxy.send("onPlay",{})}bindPlayingFlag=true;if(isFirstCanPlay){GS_proxy.send("onStatus",{type:9,explain:"视频第一次缓冲播放开始"});isFirstCanPlay=false}Gensee_VIDEO_START_CURRENT_TIME=app.globalData.currentTime;console.log("videoEnd.isVideoWaiting: "+videoEnd.isVideoWaiting);videoEnd.isVideoWaiting=false;Gensee_VIDEO_Status="play"},sendLeaveInfo:function(){console.log("[sendLeaveInfo]The url"+closedUrl);media.getJSON(closedUrl)}};var GS_proxy={defaultObj:{chatSubmitDate:new Array(),qaSubmitDate:new Array()},getSubmitDate:function(e,a){var d;if(e.length>0){for(var c=0;e.length>c;c++){var b=e[c];if(b.frameName==a){d=b;break}}}if(tool.checkObjectIsNull(d)){d={frameName:a,submitDate:0};e.push(d)}return d},send:function(a,b){channel.send(a,b)},bind:function(b,a){if(b.toLowerCase()=="submitchat"){channel.bind("submitChat",function(e){var f=new Date().getTime();var d={};if(submitInterval!=""&&(submitInterval-0)>1){d=GS_proxy.getSubmitDate(GS_proxy.defaultObj.chatSubmitDate);if(submitInterval*1000>f-d.submitDate){if(tool.isFunction(e.cb)){e.cb.call(undefined,{data:e.data,result:false})}return false}}d.submitDate=f;var c=sendMessage.sendChatDataAll(e.data);e.data.uuidStr=c;if(tool.isFunction(e.cb)){e.cb.call(undefined,{data:e.data,result:true})}})}if(b.toLowerCase()=="submitquestion"){channel.bind("submitQuestion",function(d){var e=new Date().getTime();d.data.id=tool.createUUID();var c={};if(submitInterval!=""&&(submitInterval-0)>1){c=GS_proxy.getSubmitDate(GS_proxy.defaultObj.qaSubmitDate);if(submitInterval*1000>e-c.submitDate){if(tool.isFunction(d.cb)){d.cb.call(undefined,{data:d.data,result:false})}return}}c.submitDate=e;sendMessage.sendData(d.data);if(tool.isFunction(d.cb)){d.cb.call(undefined,{data:d.data,result:true})}})}if(b.toLowerCase()=="submitchatto"){channel.bind("submitChatTo",function(d){var e=new Date().getTime();var c={};if(submitInterval!=""&&(submitInterval-0)>1){c=GS_proxy.getSubmitDate(GS_proxy.defaultObj.chatSubmitDate);if(submitInterval*1000>e-c.submitDate){if(tool.isFunction(d.cb)){d.cb.call(undefined,{data:d.data,result:false})}return false}}c.submitDate=e;sendMessage.sendChatData(d.data);if(tool.isFunction(d.cb)){d.cb.call(undefined,{data:d.data,result:true})}})}if(b.toLowerCase()=="submitvote"){channel.bind("submitVote",function(c){sendMessage.submitVote(c.data)})}if(b.toLowerCase()=="submitrollcall"){channel.bind("submitRollcall",function(c){sendMessage.submitRollcall(c.data)})}if(b.toLowerCase()=="submitnetchoice"){channel.bind("submitNetChoice",function(c){sendMessage.submitNetChoice(c.data)})}if(b.toLowerCase()=="requirenetsettings"){channel.bind("requireNetSettings",function(c){GS_proxy.send("onNetSettings",media.getIDCArray())})}}};var txt_con=new Array();var txt_time="";var chat={loadChat:function(a){txt_con.push(a);if(txt_time==""){txt_time=setTimeout(chat.txt_echo,100)}},txt_echo:function(){GS_proxy.send("onPublicChat",txt_con);clearTimeout(txt_time);txt_time="";txt_con=new Array()}};var sendMessage={escapeContent:function(b){if(!tool.checkObjectIsNull(b)){var a=sendMessage.replayFontSetting(b);b=a.richtext;b=b.replace(/\$/gi,"$0");b=b.replace(/\<div\>/gi,"");b=b.replace(/\<\/div\>/gi,"$br");b=b.replace(/\<p\>/gi,"");b=b.replace(/\<\/p\>/gi,"$br");b=b.replace(/\<br\/\>/gi,"$br");b=b.replace(/\<br\>/gi,"$br");b=b.replace(/\</gi,"&lt;");b=b.replace(/\</gi,"&lt;");b=b.replace(/\>/gi,"&gt;");b=b.replace(/["]/gi,"&quot;");b=b.replace(/[']/gi,"&#39;");b=b.replace(/\//gi,"&#47;");b=b.replace(/\\/gi,"&#92;");b=b.replace(/\$br/gi,"<br/>");b=b.replace(/\$0/gi,"$");b=a.startReplaceContent+b+a.endReplaceContent}return b},replayFontSetting:function(f){var c={};c.richtext=f;c.startReplaceContent="";c.endReplaceContent="";if(f.indexOf("<font")==0){var a=f.indexOf(">");var b=f.substring(0,a+1);var d=f.indexOf("</font>");if(d>0&&d+"</font>".length==f.length){var e=f.substring(d);c.richtext=f.substring(a+1,d);c.startReplaceContent=b;c.endReplaceContent=e}}return c},sendFocus:function(h){var d=Gensee_Now_Status_Call;var g=tool.extend({},Gensee_Statu_default,h);Gensee_Statu_default=g;console.log("[sendFocus]the ");var e=d==1?g.ROLLCALL_STARTING:(d==2?g.ROLLCALL_PRESENT:(d==3?g.ROLLCALL_ABSENT:0));var b=(g.isMute&&!g.isAudioChatting)?false:isNaN(g.isActive)?g.isFocus:g.isActive==1;var a=(g.isFilterQuestion?g.USER_STATUS_MUTE_CHAT:g.USER_STATUS_DEFAULT)|(g.isWantToUpgrade?g.USER_REQUEST_UPGRADE:g.USER_STATUS_DEFAULT)|(b?g.USER_STATUS_DEFAULT:g.USER_STATUS_FOCUS)|e|(g.isAudioInviting?g.WEB_AUDIO_INVITE:g.USER_STATUS_DEFAULT)|(g.isAudioChatting?g.WEB_AUDIO_CHATTING:g.USER_STATUS_DEFAULT);var c=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"ems"}]},"UTF-8");var f=xmloperation.createNode({nodeName:"focus",attrArray:[{name:"userstatus",value:a}]});var c=xmloperation.addNode(c,f);console.log("[sendRollCall]The data is "+c);sendMessage.sendContentByJson("&data="+encodeURIComponent(c)+"&callback=?&lasttimestamp="+lasttimestamp)},submitQuestion:function(a){if(!tool.checkObjectIsNull(a)&&!tool.checkObjectIsNull(a.content)){sendMessage.sendData(a)}else{sendMessage.sendErrorInfo({api:"submitQuestion",param:a,explain:"format error.",type:2})}},sendErrorInfo:function(a){GS_proxy.send("onAPIError",a)},chatFilterByRichtext:function(c,b){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var a=new Date().getTime();wx.request({url:wordsFilterApi+"/wordfilter/query?siteid="+c_siteid+"&confid="+c_confid+"&servicetype="+c_servicetype+"&text="+encodeURIComponent(c)+"&timestamp="+a,header:{"content-type":"application/json"},success:function(d){var e=d.data;if(e.rc=="0"){b.richtext=e.text;sendMessage.emotionContent(b)}else{if(e.rc=="1002"){console.log("Text filtering failed.")}else{console.log("the status of data is unknown:"+e.rc)}}sendMessage.sendChatData(b)},complete:function(d){},fail:function(d){sendMessage.emotionContent(b);sendMessage.sendChatData(b)}})}else{console.log("The send chat Data is fail,the user is mute.")}},chatFilterByContent:function(a,c){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var b=new Date().getTime();wx.request({url:wordsFilterApi+"/wordfilter/query?siteid="+c_siteid+"&confid="+c_confid+"&servicetype="+c_servicetype+"&text="+encodeURIComponent(a)+"&timestamp="+b,header:{"content-type":"application/json"},success:function(d){var e=d.data;if(e.rc=="0"){c.content=e.text;sendMessage.emotionRichtext(c)}else{if(e.rc=="1002"){console.log("Text filtering failed.")}else{console.log("the status of data is unknown:"+e.rc)}}sendMessage.sendChatData(c)},complete:function(d){},fail:function(d){sendMessage.emotionRichtext(c);sendMessage.sendChatData(c)}})}else{console.log("The send chat Data is fail,the user is mute.")}},submitChatTo:function(a){if(tool.checkObjectIsNull(a.security)||a.security=="default"){if(!tool.checkObjectIsNull(a.richtext)){a.richtext=a.richtext.replace(/\<script/gi,"");a.richtext=a.richtext.replace(/&lt;script/gi,"")}if(!tool.checkObjectIsNull(a.content)){a.content=a.content.replace(/\<script/gi,"");a.content=a.content.replace(/&lt;script/gi,"")}if(!(tool.checkObjectIsNull(a.richtext)||a.richtext=="")){if(wordsFilterApi!=""){sendMessage.chatFilterByRichtext(a.richtext,a)}else{sendMessage.emotionContent(a);sendMessage.sendChatData(a)}}else{if(wordsFilterApi!=""){sendMessage.chatFilterByContent(a.content,a)}else{sendMessage.emotionRichtext(a);sendMessage.sendChatData(a)}}}else{if(!(tool.checkObjectIsNull(a.richtext)||a.richtext=="")){a.richtext=sendMessage.escapeContent(a.richtext);if(wordsFilterApi!=""){sendMessage.chatFilterByRichtext(a.richtext,a)}else{sendMessage.emotionContent(a);sendMessage.sendChatData(a)}}else{if(wordsFilterApi!=""){sendMessage.chatFilterByContent(a.content,a)}else{sendMessage.emotionRichtext(a);sendMessage.sendChatData(a)}}}},chatAllFilterByContent:function(a,c){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var b=new Date().getTime();wx.request({url:wordsFilterApi+"/wordfilter/query?siteid="+c_siteid+"&confid="+c_confid+"&servicetype="+c_servicetype+"&text="+encodeURIComponent(a)+"&timestamp="+b,header:{"content-type":"application/json"},success:function(d){if(data.rc=="0"){c.content=data.text;sendMessage.emotionRichtext(c)}else{if(data.rc=="1002"){console.log("Text filtering failed.")}else{console.log("the status of data is unknown:"+data.rc)}}sendMessage.sendChatDataAll(c)},complete:function(d){},fail:function(d){sendMessage.emotionRichtext(c);sendMessage.sendChatDataAll(c)}})}else{console.log("The send chat Data is fail,the user is mute.")}},chatAllFilterByRichtext:function(c,b){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var a=new Date().getTime();wx.request({url:wordsFilterApi+"/wordfilter/query?siteid="+c_siteid+"&confid="+c_confid+"&servicetype="+c_servicetype+"&text="+encodeURIComponent(c)+"&timestamp="+a,header:{"content-type":"application/json"},success:function(d){var e=d.data;if(e.rc=="0"){b.richtext=e.text;sendMessage.emotionContent(b)}else{if(e.rc=="1002"){console.log("Text filtering failed.")}else{console.log("the status of data is unknown:"+e.rc)}}sendMessage.sendChatDataAll(b)},complete:function(d){},fail:function(d){sendMessage.emotionContent(b);sendMessage.sendChatDataAll(b)}})}else{console.log("The send chat Data is fail,the user is mute.")}},replace:function(d,c){for(var b=0;b<c.length;b++){var a=c[b];d=d.replace(a[0],a[1])}return d},emotionRichtext:function(a){a.richtext=sendMessage.replace(a.content,[[/&/gi,"&amp;"]]);a.richtext=sendMessage.replace(a.richtext,[[/\</gi,"&lt;"],[/\>/gi,"&gt;"],[/\n/g,"<br/>"],[/["]/gi,"&quot;"],[/[']/gi,"&#39;"],[/\//gi,"&#47;"],[/\\/gi,"&#92;"]])},emotionContent:function(a){a.content=sendMessage.replace(a.richtext,[[/&quot;/gi,'"'],[/&#39;/gi,"'"],[/&#47;/gi,"/"],[/&#92;/gi,"\\"],[/&amp;/gi,"&"],[/&nbsp;/gi," "],[/\<br\>/gi,String.fromCharCode(10)],[/&lt;/gi,"<"],[/&gt;/gi,">"],[/\<br\/\>/gi,String.fromCharCode(10)],[/\<\/div\>/gi,String.fromCharCode(10)],[/\<div\>/gi,""],[/\<p\>/gi,""],[/\<\/p\>/gi,String.fromCharCode(10)]])},submitChat:function(a){if(tool.checkObjectIsNull(a.security)||a.security=="default"){if(!tool.checkObjectIsNull(a.richtext)){a.richtext=a.richtext.replace(/\<script/gi,"");a.richtext=a.richtext.replace(/&lt;script/gi,"")}if(!tool.checkObjectIsNull(a.content)){a.content=a.content.replace(/\<script/gi,"");a.content=a.content.replace(/&lt;script/gi,"")}if(!(tool.checkObjectIsNull(a.richtext)||a.richtext=="")){if(wordsFilterApi!=""){sendMessage.chatAllFilterByRichtext(a.richtext,a)}else{sendMessage.emotionContent(a);sendMessage.sendChatDataAll(a)}}else{if(wordsFilterApi!=""){sendMessage.chatAllFilterByContent(a.content,a)}else{sendMessage.emotionRichtext(a);sendMessage.sendChatDataAll(a)}}}else{if(!(tool.checkObjectIsNull(a.richtext)||a.richtext=="")){a.richtext=sendMessage.escapeContent(a.richtext);if(wordsFilterApi!=""){sendMessage.chatAllFilterByRichtext(a.richtext,a)}else{sendMessage.emotionContent(a);sendMessage.sendChatDataAll(a)}}else{if(wordsFilterApi!=""){sendMessage.chatAllFilterByContent(a.content,a)}else{sendMessage.emotionRichtext(a);sendMessage.sendChatDataAll(a)}}}},qaFilter:function(b,a){wx.request({url:wordsFilterApi+"/wordfilter/query?siteid="+c_siteid+"&confid="+c_confid+"&servicetype="+c_servicetype+"&text="+encodeURIComponent(b.content)+"&timestamp="+a,header:{"content-type":"application/json"},success:function(c){var d=c.data;if(d.rc=="0"){b.content=d.text}else{if(d.rc=="1002"){console.log("Text filtering failed.")}else{console.log("the status of data is unknown:"+d.rc)}}sendMessage.sendDataFilter(b)},complete:function(c){},fail:function(c){sendMessage.sendDataFilter(b)}})},sendData:function(b){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_QA){var a=new Date().getTime();if(wordsFilterApi!=""){sendMessage.qaFilter(b,a)}else{sendMessage.sendDataFilter(b)}}},sendDataFilter:function(d){var a="";if(d.id){a=d.id}else{a=tool.createUUID()}var b=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"qa"},{name:"userid",value:c_userid}]},"UTF-8");var c=xmloperation.createNode({nodeName:"qamsg",value:d.content,attrArray:[{name:"name",value:c_username},{name:"id",value:a}]},true);var b=xmloperation.addNode(b,c);console.log("[sendData]The send content is:"+b);if(tool.checkObjectIsNull(sendUrl)){return false}else{sendMessage.sendContentByJson("&data="+encodeURIComponent(b)+"&callback=?&lasttimestamp="+lasttimestamp);return true}},sendChatData:function(c){console.log(" wo shi sendchatdata");if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var a=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"chat"},{name:"userid",value:c.receiverId}]},"UTF-8");var b=xmloperation.createNodeText({nodeName:"ems",value:c.content,textArray:[{nodeName:"richtext",value:c.richtext}],attrArray:[{name:"type",value:"chat"},{name:"sender",value:c_username},{name:"senderId",value:c_userid},{name:"group",value:"0"}]});var a=xmloperation.addNode(a,b);console.log("[sendData]The send content is:"+a);sendMessage.sendContentByJson("&data="+encodeURIComponent(a)+"&callback=?&lasttimestamp="+lasttimestamp)}else{console.log("The send chat Data is fail,the user is mute.")}},sendContentByJson:function(a){if(!tool.checkObjectIsNull(websocketServer)&&socketOpen){if(!media.onSocketMessage(sendCmd+a)){console.log("The websocketServer send content is fail.");media.getJSON(sendUrl+a)}else{console.log("The websocketServer send content is success.")}}else{console.log("The websocketServer cann't send content.");media.getJSON(sendUrl+a)}},sendChatDataAll:function(d){if(!Gensee_Statu_default.isFilterQuestion&&Gensee_Status_Chat){var a="";if(d.id){a=d.id}else{a=tool.createUUID()}var b=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"groupchat"}]},"UTF-8");var c=xmloperation.createNodeText({nodeName:"ems",value:d.content,textArray:[{nodeName:"richtext",value:d.richtext}],attrArray:[{name:"type",value:"chat"},{name:"sender",value:c_username},{name:"senderId",value:c_userid},{name:"group",value:"1"},{name:"id",value:a}]});var b=xmloperation.addNode(b,c);console.log("[sendData]The send content is:"+b);sendMessage.sendContentByJson("&data="+encodeURIComponent(b)+"&callback=?&lasttimestamp="+lasttimestamp);return a}else{console.log("The send chat Data is fail,the user is mute.")}},submitVote:function(b){b.rootType="vote";var a=sendMessage.checkVote(b);if(!a.result){sendMessage.sendErrorInfo({api:"submitVote",param:b,explain:a.explain,type:a.type});return}sendMessage.sendVoteOrSurvery([sendMessage.dealVoteSubmit(b)])},checkVote:function(e){if(tool.checkObjectIsNull(e)){return{result:false,type:2,explain:"lack attribute"}}if(tool.checkObjectIsNull(e.id)||tool.checkObjectIsNull(e.questions)){return{result:false,type:2,explain:"lack attribute"}}if(tool.checkObjectIsNull(e.questions.length)||e.questions.length<=0){return{result:false,type:1,explain:"format error"}}for(var d=0;d<e.questions.length;d++){var a=e.questions[d];if(tool.checkObjectIsNull(a.type)){return{result:false,type:2,explain:"lack attribute"}}if(a.type=="text"){if(tool.checkObjectIsNull(a.text)){return{result:false,type:2,explain:"lack attribute"}}}else{if(a.type!="multi"&&a.type!="single"){return{result:false,type:1,explain:"the value of type is wrong."}}if(tool.checkObjectIsNull(a.items)){return{result:false,type:2,explain:"lack attribute"}}if(tool.checkObjectIsNull(a.items.length)||a.items.length<=0){return{result:false,type:1,explain:"format error"}}for(var c=0;c<a.items[c];c++){var b=a.items[c];if(tool.checkObjectIsNull(b.selected)||tool.checkObjectIsNull(b.id)){return{result:false,type:2,explain:"lack attribute"}}}}}return{result:true}},dealVoteSubmit:function(g){var e={};e.rootType=g.rootType;e.ver=g.ver;e.id=g.id;e.question=new Array();for(var d=0;d<g.questions.length;d++){var b=g.questions[d];var a={};a.id=b.id;a.items=new Array();if(b.type=="text"){a.items.push({text:b.text})}else{for(var c=0;c<b.items.length;c++){var f=b.items[c];if(f.selected=="true"||f.selected==true){a.items.push({id:f.id,index:c})}}}e.question.push(a)}return e},sendVoteOrSurvery:function(c){var d=sendMessage.generationDate(c);for(var b=0;b<d.length;b++){var a=d[b];if(a.type=="service"){sendMessage.sendContentByJson("&callback=?&lasttimestamp="+lasttimestamp+"&data="+encodeURIComponent(a.xmlContent))}else{}}},generationDate:function(d){var e=new Array();for(var c=0;c<d.length;c++){var b=sendMessage.createServiceXml(d[c]);var a={type:"service",xmlContent:b};e.push(a)}return e},createWebXml:function(o){var k=o.rootType;var a="voteSubmit";var d=k=="vote";if(!d){a="surveySubmit"}var g=xmloperation.createXml({nodeName:a,attrArray:[{name:"siteid",value:c_siteid},{name:"userid",value:c_userid},{name:"username",value:c_username},{name:"confid",value:c_confid},{name:"live",value:"true"}]},"UTF-8");var h=xmloperation.createNode({nodeName:"command",attrArray:[{name:"id",value:o.id}]});var b=o.questions;for(var e=0;e<b.length;e++){var n=b[e];var m=xmloperation.createNode({nodeName:"question",attrArray:[{name:"id",value:n.id}]});for(var f=0;f<n.items.length;f++){var l=n.items[f];if(!tool.checkObjectIsNull(l.text)){if(d){var c=xmloperation.createNode({nodeName:"item",value:l.text,attrArray:[{name:"idx",value:0}]})}else{var c=xmloperation.createNode({nodeName:"item",value:l.text})}m=xmloperation.addNode(m,c)}else{var c=xmloperation.createNode({nodeName:"item",attrArray:[{name:"idx",value:l.index}]});m=xmloperation.addNode(m,c)}}h=xmloperation.addNode(h,m)}g=xmloperation.addNode(g,h);console.log("[createWebXml]The content:"+g);return g},createServiceXml:function(l){var e=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"vote"},{name:"userid",value:c_userid},{name:"site",value:c_siteid},{name:"live",value:"true"},{name:"confid",value:c_confid},{name:"username",value:c_username},{name:"ver",value:l.ver}]},"UTF-8");var f=xmloperation.createNode({nodeName:"command",attrArray:[{name:"id",value:l.id},{name:"type",value:"submit"},{name:"userid",value:c_userid}]});var a=l.question;for(var c=0;c<a.length;c++){var k=a[c];var h=xmloperation.createNode({nodeName:"question",attrArray:[{name:"id",value:k.id}]});for(var d=0;d<k.items.length;d++){var g=k.items[d];if(!tool.checkObjectIsNull(g.text)){var b=xmloperation.createNode({nodeName:"item",value:g.text,attrArray:[{name:"idx",value:0},{name:"id",value:""}]});h=xmloperation.addNode(h,b)}else{var b=xmloperation.createNode({nodeName:"item",attrArray:[{name:"id",value:g.id},{name:"idx",value:g.index}]});h=xmloperation.addNode(h,b)}}f=xmloperation.addNode(f,h)}e=xmloperation.addNode(e,f);console.log("[createServiceXml]The content:"+e);return e},submitRollcall:function(a){if(Gensee_Roll_Call!=null&&Gensee_Roll_Call.id==a.id){clearTimeout(Gensee_Roll_Call_Timeout);Gensee_Roll_Call=null;if(Gensee_ROLL_CALL_TYPE=="rollCall2"){sendMessage.sendRollCallACK(a.id)}else{sendMessage.sendRollCall(2)}}},sendRollCallACK:function(c){var a=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"rollCall2Ack"}]},"UTF-8");var b=xmloperation.createNode({nodeName:"ems",attrArray:[{name:"type",value:"rollCall2Ack"},{name:"senderId",value:c},{name:"destid",value:c},{name:"time",value:new Date().getTime()}]});var a=xmloperation.addNode(a,b);console.log("[sendRollCallACK]The data is "+a);sendMessage.sendContentByJson("&data="+encodeURIComponent(a)+"&callback=?&lasttimestamp="+lasttimestamp)},sendRollCall:function(d,h){Gensee_Now_Status_Call=d;var g=tool.extend({},Gensee_Statu_default,h);Gensee_Statu_default=g;var e=d==1?g.ROLLCALL_STARTING:(d==2?g.ROLLCALL_PRESENT:(d==3?g.ROLLCALL_ABSENT:0));var b=(g.isMute&&!g.isAudioChatting)?false:isNaN(g.isActive)?g.isFocus:g.isActive==1;var a=(g.isFilterQuestion?g.USER_STATUS_MUTE_CHAT:g.USER_STATUS_DEFAULT)|(g.isWantToUpgrade?g.USER_REQUEST_UPGRADE:g.USER_STATUS_DEFAULT)|(b?g.USER_STATUS_DEFAULT:g.USER_STATUS_FOCUS)|e|(g.isAudioInviting?g.WEB_AUDIO_INVITE:g.USER_STATUS_DEFAULT)|(g.isAudioChatting?g.WEB_AUDIO_CHATTING:g.USER_STATUS_DEFAULT);var c=xmloperation.createXml({nodeName:"module",attrArray:[{name:"name",value:"ems"}]},"UTF-8");var f=xmloperation.createNode({nodeName:"rollcall",attrArray:[{name:"userstatus",value:a}]});var c=xmloperation.addNode(c,f);console.log("[sendRollCall]The data is "+c);sendMessage.sendContentByJson("&data="+encodeURIComponent(c)+"&callback=?&lasttimestamp="+lasttimestamp)},submitNetChoice:function(a){sendMessage.choosePriorNetwork(a.label)},choosePriorNetwork:function(a){var c=idcArray;var d=null;for(var b=0;b<c.length;b++){if(a==c[b].description){d=c[b];break}}if(d!=null&&c_idc!=d.code){c_idc=d.code;c_ipowner=d.supported;GS_proxy.send("onNetSettings",media.getIDCArray());ALBurl=visitScheme+connectALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+d.code+"&ipowner="+d.supported+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?";if(isOpenBak){ALBBakUrl=visitScheme+connectBakALBSvr+"/albcmd/ping?siteid="+c_siteid+"&responsetype="+c_responsetype+"&confid="+c_confid+"&confname="+c_confname+"&confpasswd="+c_confpassword+"&servicetype="+c_servicetype+"&userid="+c_userid+"&idc="+d.code+"&ipowner="+d.supported+"&failover="+c_ping_failover+"&mainidc="+c_mainidc+"&t="+Math.random()+"&callback=?"}media.expire()}}};var taskDeal={annoFirstDealFunction:function(b,a){taskObj.addTask("annoFirst",b,null,null)},pptDealFunction:function(c){for(var a=0;a<c.pageArray.length;a++){var b=c.pageArray[a];console.log("[pptDealFunction]page.starttimestamp :"+b.starttimestamp+";**"+c.inittimestamp);if(Gensee_Now_Doc_Url_SDK!=null){if(Gensee_Now_Doc_Url_SDK==b.hls){return}}Gensee_Now_Doc_Url_SDK=b.hls;taskObj.addTask(Gensee_SDK_Task_PPT_MODULE,b,(b.starttimestamp-c.inittimestamp),null);if(hisAnnoArray.length>0){for(var a=0;a<hisAnnoArray.length;a++){var d=hisAnnoArray[a];if(Gensee_Now_Doc_Url_SDK!=d.hls){hisAnnoArray.splice(a,1);a--}}taskDeal.annoFirstDealFunction(hisAnnoArray);hisAnnoArray=new Array()}if(refreshflag){Gensee_Now_Doc_Url_SDK=null}}},annoDealFunction:function(c){for(var b=0;b<c.annoArray.length;b++){var d=c.annoArray[b];console.log("[annoDealFunction]page.starttimestamp :"+d.starttimestamp+";**"+c.inittimestamp);for(var b=0;b<d.annoArray.length;b++){var a=d.annoArray[b];if(Gensee_Now_Doc_Url_SDK!=null){if(Gensee_Now_Doc_Url_SDK!=a.hls){d.annoArray.splice(b,1);b--}}}taskObj.addTask(Gensee_SDK_Task_ANNOTATION_SDK,d,(d.starttimestamp-c.inittimestamp),null)}}};var analysis={sortPpt:function(d){for(var c=0;c<d.length-1;c++){for(var b=0;b<d.length-1-c;b++){if((d[b].starttimestamp-d[b+1].starttimestamp)>0){var a=d[b];d[b]=d[b+1];d[b+1]=a}}}return d},analysisAnno:function(u){console.log("[analysisAnno] The content is:"+u);var g={};var s=new Array();var c=analysis.parseXml(u);var y=c.documentElement;var x=y.getElementsByTagName("command");for(var w=0;w<x.length;w++){var b={};var r=x[w];var o=new Array();b.id=analysis.getXmlNodeAttr(r,"id");b.type=analysis.getXmlNodeAttr(r,"type");b.documentid=analysis.getXmlNodeAttr(r,"documentid");b.pageid=analysis.getXmlNodeAttr(r,"pageid");b.color=analysis.getXmlNodeAttr(r,"color");b.linesize=analysis.getXmlNodeAttr(r,"linesize");b.fontsize=analysis.getXmlNodeAttr(r,"fontsize");b.style=analysis.getXmlNodeAttr(r,"style");b.removed=analysis.getXmlNodeAttr(r,"removed");b.starttimestamp=Number(analysis.getXmlNodeAttr(r,"timestamp"))*1000;b.hls=visitUrl+b.documentid+"_"+b.pageid+".png";if(b.hls.indexOf("?")>0){b.hls=b.hls+"&sessionid="+SESSIONID}else{b.hls=b.hls+"?sessionid="+SESSIONID}if(b.type=="2"){var d=r.getElementsByTagName("p");var o=new Array();for(var v=0;v<d.length;v++){var A=analysis.getNodeValue(d[v]);o.push(A)}b.p=o}else{if(b.type=="4"){var d=r.getElementsByTagName("p");var k=r.getElementsByTagName("ep");var h=r.childNodes[5].nodeValue;if(d.length>0){b.p=analysis.getNodeValue(d[0])}if(k.length>0){b.ep=analysis.getNodeValue(k[0])}b.value=h}else{var d=r.getElementsByTagName("p");var k=r.getElementsByTagName("ep");if(d.length>0){b.p=analysis.getNodeValue(d[0])}if(k.length>0){b.ep=analysis.getNodeValue(k[0])}}}s.push(b)}s=analysis.sortPpt(s);var e=s.length;g.annoArray=new Array();if(e>0){var m=new Array();var t="";var q=0;for(var w=0;w<e;w++){var a=s[w];if(t==""){t=a.documentid+"_"+a.pageid;m[q]=new Array()}if(t==a.documentid+"_"+a.pageid){m[q].push(a)}else{q+=1;m[q]=new Array();t=a.documentid+"_"+a.pageid;m[q].push(a)}}if(m.length>0){var l=m[m.length-1];var f={};f.annoArray=l;var z=l.length;if(z>0){f.taskId=l[0].documentid+"_"+l[0].pageid+"_"+l[0].id+"_"+l[0].starttimestamp+"_"+z;if(app.globalData.currentTime>5){f.starttimestamp=l[0].starttimestamp;f.stoptimestamp=""}else{f.starttimestamp=inittimestamp;f.stoptimestamp=inittimestamp}g.annoArray.push(f)}}}return g},analysisQaList:function(a){console.log("[analysisQaList] The content is:"+a);var h=analysis.parseXml(a);var d=h.documentElement;var b={};b.list=new Array();var c=d.getElementsByTagName("qa");for(var g=0;g<c.length;g++){var j=c[g];var e={};e.id=analysis.getXmlNodeAttr(j,"id");e.question=analysis.getXmlNodeAttr(j,"question");e.submitor=analysis.getXmlNodeAttr(j,"questionowner");var f=analysis.getXmlNodeAttr(j,"removed");if(f=="true"){e.remove=true}e.qaownerId=analysis.getXmlNodeAttr(j,"questionownerid");e.answer=analysis.getXmlNodeAttr(j,"answer");e.answerBy=analysis.getXmlNodeAttr(j,"answerowner");e.submitTime=analysis.getXmlNodeAttr(j,"questiontimestamp");e.answerTime=analysis.getXmlNodeAttr(j,"qaanswertimestamp");b.list.push(e)}return b},sortQaList:function(d){for(var c=0;c<d.length-1;c++){for(var b=0;b<d.length-1-c;b++){if((d[b].submitTime-d[b+1].submitTime)>0){var a=d[b];d[b]=d[b+1];d[b+1]=a}}}return d},analysisQaType:function(b){var c=analysis.parseXml(b);var a=c.documentElement;return analysis.getXmlNodeAttr(a,"name")},analysisQa:function(m){console.log("[analysisQa] The content is:"+m);var l={};var c=analysis.parseXml(m);var s=c.documentElement;var v=analysis.getXmlNodeAttr(s,"name");if(v=="qahistroy"){return analysis.analysisQaList(m)}var g=new Array();var r=s.getElementsByTagName("qa");var a=new Array();for(var o=0;o<r.length;o++){var e=r[o];var u={};u.publishtimestamp=analysis.dealStartTime(analysis.getXmlNodeAttr(e,"timestamp"));u.id=analysis.getXmlNodeAttr(e,"id");u.cmd=analysis.getXmlNodeAttr(e,"cmd");if(!tool.checkObjectIsNull(u.cmd)&&u.cmd.length>0){if(u.cmd=="cancelHighlight"){u.questionid=u.id;a.push(u);continue}var b=e.getElementsByTagName("question")[0];if(tool.checkObjectIsNull(b)){continue}u.questionid=u.id;u.questionuid=analysis.getXmlNodeAttr(b,"uid");u.questionowner=analysis.getXmlNodeAttr(b,"name");u.questionownerid=analysis.getXmlNodeAttr(b,"questionownerid");u.questiontimestamp=analysis.getXmlNodeAttr(b,"time");u.question="";var f=b.childNodes.length;for(var n=0;n<f;n++){u.question+=tool.trim(b.childNodes[n].nodeValue)}var q=e.getElementsByTagName("answer");if(!tool.checkObjectIsNull(q)){u.answerList=new Array();for(var h=0;h<q.length;h++){var d=q[h];var t={};if(!tool.checkObjectIsNull(d)){t.answerid=analysis.getXmlNodeAttr(d,"uid");t.answerowner=analysis.getXmlNodeAttr(d,"name");t.answertimestamp=analysis.getXmlNodeAttr(d,"time");t.answer="";f=d.childNodes.length;for(var n=0;n<f;n++){t.answer+=tool.trim(d.childNodes[n].nodeValue)}}u.answerList.push(t)}}a.push(u)}else{var b=e.getElementsByTagName("question")[0];if(tool.checkObjectIsNull(b)){continue}var p=analysis.getXmlNodeAttr(b,"removed");if(p=="true"){u.removed=true}else{u.removed=false}u.id=analysis.getXmlNodeAttr(b,"id");u.submitor=analysis.getXmlNodeAttr(b,"user");u.qaownerId=analysis.getXmlNodeAttr(b,"questionownerid");u.submitTime=analysis.getXmlNodeAttr(b,"timestamp");u.question="";var f=b.childNodes.length;for(var n=0;n<f;n++){u.question+=tool.trim(b.childNodes[n].nodeValue)}var d=e.getElementsByTagName("answer")[0];if(!tool.checkObjectIsNull(d)){u.answerBy=analysis.getXmlNodeAttr(d,"user");u.answerTime=analysis.getXmlNodeAttr(d,"timestamp");u.answer="";f=d.childNodes.length;for(var n=0;n<f;n++){u.answer+=tool.trim(d.childNodes[n].nodeValue)}}g.push(u)}}g=analysis.sortQaArray(g);l.qaArray=g;l.pushQaList=a;return l},sortQaArray:function(d){for(var c=0;c<d.length-1;c++){for(var b=0;b<d.length-1-c;b++){if((d[b].publishtimestamp-d[b+1].publishtimestamp)>0){var a=d[b];d[b]=d[b+1];d[b+1]=a}}}return d},dealStartTime:function(a){if(app.globalData.currentTime>5){return a}else{return inittimestamp}},analysisVote:function(v){var g={};console.log("[Vote Ver]The content is:"+v);var u={};var f=analysis.parseXml(v);var B=f.documentElement;Gensee_VER=analysis.getXmlNodeAttr(B,"ver");var a=new Array();var y=new Array();var A=B.getElementsByTagName("command");for(var x=0;x<A.length;x++){var r=A[x];var e={};e.id=analysis.getXmlNodeAttr(r,"id");e.skip=analysis.getXmlNodeAttr(r,"skip");var m=analysis.getXmlNodeAttr(r,"total");var C=m!=""&&m.length>0?true:false;if(C){e.total=m}var d=r.childNodes;for(var w=0;w<d.length;w++){var c=d[w];if(c.nodeName=="subject"){e.subject=analysis.getNodeValue(c);break}}var q=r.getElementsByTagName("question");e.questions=new Array();for(var w=0;w<q.length;w++){var b=q[w];var o={};o.id=analysis.getXmlNodeAttr(b,"id");o.type=analysis.getXmlNodeAttr(b,"type");var l=b.childNodes;if(C){o.total=analysis.getXmlNodeAttr(b,"total")}else{o.answer=analysis.getXmlNodeAttr(b,"answer")}for(var s=0;s<l.length;s++){var c=l[s];if(c.nodeName=="subject"){o.subject=analysis.getNodeValue(c);break}}if(o.type!="text"&&o.type.length>0){o.score=analysis.getXmlNodeAttr(b,"score");var p=b.getElementsByTagName("item");o.items=new Array();for(var n=0;n<p.length;n++){var z=p[n];var h={};h.id=analysis.getXmlNodeAttr(z,"id");h.option=analysis.getNodeValue(z);if(C){h.total=analysis.getXmlNodeAttr(z,"total")}else{h.correct=analysis.getXmlNodeAttr(z,"correct");h.selected=false}o.items.push(h)}}if(o.type=="text"){o.text=""}e.questions.push(o)}if(C){y.push(e)}else{a.push(e)}}g.contentArray=a;g.resultArray=y;return g},analysisSurvey:function(a){var t={};console.log("[survey]The content is:"+a);var t={};var m=analysis.parseXml(a);var d=m.documentElement;var o=new Array();var s=d.getElementsByTagName("command");for(var l=0;l<s.length;l++){var h=s[l];var q={};q.rootType="survey";q.id=analysis.getXmlNodeAttr(h,"id");q.type=analysis.getXmlNodeAttr(h,"type");q.skip=analysis.getXmlNodeAttr(h,"skip");q.timestamp=analysis.getXmlNodeAttr(h,"timestamp");var r=h.childNodes;for(var g=0;g<r.length;g++){var n=r[g];if(n.nodeName=="subject"){q.subject=analysis.getNodeValue(n);break}}var c=h.getElementsByTagName("question");q.question=new Array();for(var g=0;g<c.length;g++){var f=c[g];var p={};p.id=analysis.getXmlNodeAttr(f,"id");p.type=analysis.getXmlNodeAttr(f,"type");p.answer=analysis.getXmlNodeAttr(f,"answer");var b=f.childNodes;for(var e=0;e<b.length;e++){var n=b[e];if(n.nodeName=="subject"){p.subject=analysis.getNodeValue(n);break}}q.question.push(p)}o.push(q)}t.contentArray=o;return t},getXmlNodeAttr:function(b,a){if(!b){return""}if(!b.attributes){return""}if(b.attributes[a]!=null){return b.attributes[a].value}if(b.attributes.getNamedItem(a)!=null){return b.attributes.getNamedItem(a).value}return""},lastAddress:function(b){b=b.replace(/(^\s*)|(\s*$)/g,"");var a=b.lastIndexOf("/");if(b.lastIndexOf("/")>0){return b.substring(0,a+1)}else{return b}},fillUrl:function(b,a){b=b.replace(/(^\s*)|(\s*$)/g,"");if(b.indexOf("http://")==0||b.indexOf("https://")==0){return b}else{return analysis.lastAddress(a)+b}},getNodeValue:function(b){var a=b.textContent.replace(/(^\s*)|(\s*$)/g,"");return a},analysisRole:function(a){var b="";if(a!=""){a=a-0;if(a%2==1){b=b+"1,";a=a-1}if(a%4==2){b=b+"2,";a=a-2}if(a%8==4){b=b+"4,";a=a-4}if(a%16==8){b=b+"8,";a=a-8}if(a-16==0){b=b+"16,"}if(b.length>0){b=b.substring(0,b.length-1)}}return b},analysisVideoParam:function(f){var e=new Array();var c=analysis.parseXml(f);var b=c.documentElement;var a=b.getElementsByTagName("videoparam");for(var d=0;d<a.length;d++){var g={};g.width=analysis.getXmlNodeAttr(a[d],"width");g.height=analysis.getXmlNodeAttr(a[d],"height");g.isas=analysis.getXmlNodeAttr(a[d],"isas");e.push(g)}return e},analysisUsernum:function(g){console.log("[analysisUsernum] The content is:"+g);var d=analysis.parseXml(g);var c=new Array();var b=d.documentElement;var f=b.getElementsByTagName("usernum");for(var e=0;e<f.length;e++){var a={};a.timestamp=analysis.getXmlNodeAttr(f[e],"timestamp");a.num=analysis.getXmlNodeAttr(f[e],"num");c.push(a)}return c},parseXml:function(b){var c;var a=new Parser;c=a.parseFromString(b);b=c;return b},analysisEms:function(c){console.log("[ems]"+c);var J={};var z=analysis.parseXml(c);var h=z.documentElement;var A=new Array();var C=new Array();var u=h.getElementsByTagName("ems");if(tool.checkObjectIsNull(u)||u.length==0){u=new Array();u.push(h)}for(var X=0;X<u.length;X++){J={};var q=u[X];var af=analysis.getXmlNodeAttr(q,"type");console.log("[ems]"+q);if(af!=""&&af!=undefined&&af!=null){J.type=af}if(af=="publicMsg"){J.content=analysis.getNodeValue(q)}else{if(af=="chat"){var aa=analysis.getXmlNodeAttr(q,"groupid");var y=analysis.getXmlNodeAttr(q,"group");J.senderRole=analysis.analysisRole(analysis.getXmlNodeAttr(q,"senderRole"));var N=analysis.getXmlNodeAttr(q,"senderId");if(N==c_userid){continue}if(y=="1"){J.type="chat_all"}else{if(aa!=""){if(y=="2"){J.type="chat_third"}else{J.type="chat_all"}}}J.sender=analysis.getXmlNodeAttr(q,"sender");J.senderId=analysis.getXmlNodeAttr(q,"senderid");J.senderUid=analysis.getXmlNodeAttr(q,"senderId");J.id=analysis.getXmlNodeAttr(q,"id");var F=q.childNodes;console.log("[emsChildNodes.length]"+F.length);if(F==null||F.length<=1){J.content=analysis.getNodeValue(q)}else{J.content="";J.richtext="";for(var V=0;V<F.length;V++){var Y=F[V];console.log("[emsChildeNode.nodeName]"+Y.nodeName);if(Y.nodeName=="richtext"){J.richtext=J.richtext+analysis.getNodeValue(Y);console.log("[analysisEmsObj.richtext]"+J.richtext)}else{J.content=J.content+analysis.getNodeValue(Y)}}}if(gstrue){C.push(J);continue}}else{if(af=="close"){J.reason=analysis.getXmlNodeAttr(q,"reason")}else{if(af=="rollCall"||af=="rollCall2"){J.timeout=analysis.getXmlNodeAttr(q,"timeout");J.senderid=analysis.getXmlNodeAttr(q,"senderid")}else{if(af=="muteChat"){J.on=analysis.getXmlNodeAttr(q,"on");J.senderid=analysis.getXmlNodeAttr(q,"senderid")}else{if(af=="onRosterInfolist"){console.log("[onRosterInfolist anaysisly]");J.type=analysis.getXmlNodeAttr(q,"type");J.senderid=analysis.getXmlNodeAttr(q,"senderid");var H=q.getElementsByTagName("RosterInfoDisable");J.disabled=false;console.log("[rosterInfoDisable]"+H.length);if(H!=null&&H.length>0){J.disabled=true}var ad=q.getElementsByTagName("RosterInfoHistroy");var K=new Array();for(var V=0;V<ad.length;V++){var x=ad[V];var B=x.getElementsByTagName("roster");for(var T=0;T<B.length;T++){var d={};var b=B[T];d.id=analysis.getXmlNodeAttr(b,"id");d.name=analysis.getXmlNodeAttr(b,"rostername");d.chatid=analysis.getXmlNodeAttr(b,"chatuserid");var m=analysis.getXmlNodeAttr(b,"userRole");d.role=analysis.analysisRole(m);K.push(d);if(media.gstrue){var p=analysis.getXmlNodeAttr(b,"userappinfo");if(p!=undefined){p=tool.decodeHex(p);userdatas[d.id]=p}}}}J.list=K;var w=q.getElementsByTagName("RosterInfoNotify");var ab=new Array();var L=new Array();var G=new Array();for(var V=0;V<w.length;V++){var Z=w[V];var B=Z.getElementsByTagName("roster");for(var T=0;T<B.length;T++){var d={};var b=B[T];d.id=analysis.getXmlNodeAttr(b,"id");d.name=analysis.getXmlNodeAttr(b,"rostername");d.chatid=analysis.getXmlNodeAttr(b,"chatuserid");var m=analysis.getXmlNodeAttr(b,"userRole");d.role=analysis.analysisRole(m);var ae=analysis.getXmlNodeAttr(b,"notifytype");if(media.gstrue){var p=analysis.getXmlNodeAttr(b,"userappinfo");if(p!=undefined){p=tool.decodeHex(p);userdatas[d.id]=p}}if(ae=="0"){ab.push(d)}else{if(ae=="1"){L.push(d)}else{if(ae=="2"){G.push(d)}}}}}J.leaveList=L;J.joinList=ab;J.updateList=G}else{if(af=="qaenable"){J.enable=analysis.getXmlNodeAttr(q,"enable")}else{if(af=="chatenable"){J.enable=analysis.getXmlNodeAttr(q,"enable")}else{if(af=="user.rostrum"||af=="user.asker"){J.globaluserid=analysis.getXmlNodeAttr(q,"globaluserid");J.senderid=analysis.getXmlNodeAttr(q,"senderid");if(J.senderid=="0"||J.senderid-0==0){if(af=="user.rostrum"){Gensee_Host_User_Id=null}if(af=="user.asker"){Gensee_Asker_User_Id=null}}}else{if(af=="class.mode"){J.mode=analysis.getXmlNodeAttr(q,"mode");J.senderid=analysis.getXmlNodeAttr(q,"senderid")}else{if(af=="user.app.info"){var v=q.getElementsByTagName("user");var ac=new Array();for(var X=0;X<v.length;X++){var r=v[X];var g=analysis.getXmlNodeAttr(r,"globaluserid");var p=analysis.getXmlNodeAttr(r,"userappinfo");if(p!=undefined){p=tool.decodeHex(p);userdatas[g]=p}var M=false;for(var V=0;V<ac.length;V++){if(ac[V]==g){M=true}}if(!M){ac.push(g)}}var E="";ac.sort(function(j,i){return j-i});for(var X=0;X<ac.length;X++){E+="_"+ac[X]}for(var X=0;X<chatList.length;X++){if(chatList[X].keys==E){for(var V=0;V<=X;V++){var t=chatList[V].chats;var D=new Array();for(var T=0;T<t.length;T++){var a=t[T];a.inittimestamp=inittimestamp;if(userdatas[a.senderUid]!=undefined){a.userdata=userdatas[a.senderUid]}D.push(a)}}chatList.splice(0,X+1);media.emsDealFunction(D);break}}}else{if(af=="RoleStatus"){J.hostid=analysis.getXmlNodeAttr(q,"hostglobaluserid");J.hostname=analysis.getXmlNodeAttr(q,"hostusername");J.presid=analysis.getXmlNodeAttr(q,"preglobaluserid");J.presname=analysis.getXmlNodeAttr(q,"preusername")}else{if(af=="hongbao.key"){var s=q.getElementsByTagName("broadmessage")[0];var n=analysis.getXmlNodeAttr(s,"type");if(n=="hongbao"){var O=s.getElementsByTagName("hongbao")[0];var Q=analysis.getXmlNodeAttr(O,"type");var o={};if(Q=="create"){J.type="hbcreate";o.type=analysis.getXmlNodeAttr(O,"hongbaotype");o.hbid=analysis.getXmlNodeAttr(O,"id");o.username=analysis.getNodeValue(O.getElementsByTagName("username")[0]);o.comment=analysis.getNodeValue(O.getElementsByTagName("comment")[0])}else{if(Q=="grab"){J.type="hbgrabmsg";if(analysis.getXmlNodeAttr(O,"hongbaotype")>=2){o.type=1}else{o.type=0}o.hbid=analysis.getXmlNodeAttr(O,"id");o.userid=analysis.getXmlNodeAttr(O,"userid");o.amount=analysis.getXmlNodeAttr(O,"amount");o.username=analysis.getNodeValue(O.getElementsByTagName("username")[0])}}J.content=o}else{if(n=="tip"){var e=s.getElementsByTagName("tip")[0];J.type="tip";var P={};P.id=analysis.getXmlNodeAttr(e,"id");P.userid=analysis.getXmlNodeAttr(e,"userid");P.amount=analysis.getXmlNodeAttr(e,"amount");P.username=analysis.getNodeValue(e.getElementsByTagName("username")[0]);J.content=P}}}}}}}}}}}}}}}if(!tool.isEmptyObject(J)){A.push(J)}}if(media.gstrue&&C.length>0){var I=true;var E="";var ac=new Array();var a={};a.timestamp=new Date().getTime();for(var X=0;X<C.length;X++){if(userdatas[C[X].senderUid]==undefined){I=false;var M=false;for(var V=0;V<ac.length;V++){if(ac[V]==C[X].senderUid){M=true}}if(!M){ac.push(C[X].senderUid)}}else{C[X].userdata=userdatas[C[X].senderUid]}}ac.sort(function(j,i){return j-i});for(var X=0;X<ac.length;X++){E+="_"+ac[X]}a.hasInfo=I;a.keys=E;a.chats=C;chatList.push(a);if(ac.length>0){sendUserData(ac)}}var W=h.getElementsByTagName("chatcensor");if(!tool.checkObjectIsNull(W)){if(W.length>0){var f={};f.censorList=new Array();f.type="delchat";for(var X=0;X<W.length;X++){var U={};var q=W[X];var af=analysis.getXmlNodeAttr(q,"type");console.log("[chatcensor]"+q);if(af=="msg"){U.type="chat";U.id=analysis.getXmlNodeAttr(q,"id");f.censorList.push(U)}else{if(af=="user"){U.type="user";U.id=analysis.getXmlNodeAttr(q,"id");f.censorList.push(U)}}}if(f.censorList.length>0){A.push(f);if(media.gstrue){for(var V=0;V<f.censorList.length;V++){var S=f.censorList[V];if(S.type=="msg"){for(var T=0;T<chatList.length;T++){var t=chatList[T];for(var R=0;R<t.length;R++){if(t[R].id==S.id){t.splice(R,1);if(t.length==0){chatList.splice(T,1)}break}}}}else{if(S.type=="user"){for(var T=0;T<chatList.length;T++){var t=chatList[T];for(var R=0;R<t.length;R++){if(t[R].senderUid==S.id){t.splice(R,1);R--;if(t.length==0){chatList.splice(T,1);T--}}}}}}}}}}}return A},analysisHisAnno:function(a){console.log("[analysisAnno] The content is:"+a);var g={};var h=new Array();var f=a.documentElement;var r=f.getElementsByTagName("command");for(var n=0;n<r.length;n++){var o={};var m=r[n];var b=new Array();o.id=analysis.getXmlNodeAttr(m,"id");o.type=analysis.getXmlNodeAttr(m,"type");o.documentid=analysis.getXmlNodeAttr(m,"documentid");o.pageid=analysis.getXmlNodeAttr(m,"pageid");o.color=analysis.getXmlNodeAttr(m,"color");o.linesize=analysis.getXmlNodeAttr(m,"linesize");o.fontsize=analysis.getXmlNodeAttr(m,"fontsize");o.style=analysis.getXmlNodeAttr(m,"style");o.removed=analysis.getXmlNodeAttr(m,"removed");o.starttimestamp=Number(analysis.getXmlNodeAttr(m,"timestamp"))*1000;o.stoptimestamp=Number(o.starttimestamp)+1;o.hls=visitUrl+o.documentid+"_"+o.pageid+".png"+"?sessionid="+SESSIONID;if(o.type=="2"){var e=m.getElementsByTagName("p");var b=new Array();for(var k=0;k<e.length;k++){var d=analysis.getNodeValue(e[k]);b.push(d)}o.p=b}else{if(o.type=="4"){var e=m.getElementsByTagName("p");var c=m.getElementsByTagName("ep");var q=analysis.getNodeValue(m);if(e.length>0){o.p=analysis.getNodeValue(e[0]);q=q.replace(o.p,"")}if(c.length>0){o.ep=analysis.getNodeValue(c[0]);q=q.replace(o.ep,"")}o.value=q}else{var e=m.getElementsByTagName("p");var c=m.getElementsByTagName("ep");if(e.length>0){o.p=analysis.getNodeValue(e[0])}if(c.length>0){o.ep=analysis.getNodeValue(c[0])}}}h.push(o)}h=analysis.sortPpt(h);if(Gensee_Now_Doc_Url_SDK!=null){if(h.length>0){for(var n=0;n<h.length;n++){var l=h[n];if(Gensee_Now_Doc_Url_SDK!=l.hls){h.splice(n,1);n--}}}taskDeal.annoFirstDealFunction(h);hisAnnoArray=new Array()}else{hisAnnoArray=h}},analysisPpt:function(a){console.log("[analysisPpt] The content is:"+a);var c={};var h=analysis.parseXml(a);var d=h.documentElement;var e=new Array();var f=d.getElementsByTagName("page");for(var g=0;g<f.length;g++){var k={};var b=f[g];k.hls=analysis.fillUrl(analysis.getXmlNodeAttr(b,"hls"),visitUrl);if(k.hls.indexOf("?")>0){k.hls=k.hls+"&sessionid="+SESSIONID}else{k.hls=k.hls+"?sessionid="+SESSIONID}console.log("[analysisPpt]the hls :"+k.hls);k.height=analysis.getXmlNodeAttr(b,"height");k.width=analysis.getXmlNodeAttr(b,"width");k.hlsid=analysis.getXmlNodeAttr(b,"hls").replace(".png","");k.taskId=k.hlsid+"_"+analysis.getXmlNodeAttr(b,"starttimestamp");console.log("media.currentTime:"+app.globalData.currentTime);if(app.globalData.currentTime>5){k.starttimestamp=analysis.getXmlNodeAttr(b,"starttimestamp");k.stoptimestamp=analysis.getXmlNodeAttr(b,"stoptimestamp")}else{k.starttimestamp=inittimestamp;k.stoptimestamp=inittimestamp}e.push(k)}e=analysis.sortPpt(e);var j=e.length;c.pageArray=new Array();if(j>0){c.pageArray.push(e[j-1])}return c}};var xmloperation={createXml:function(a,b){if(tool.checkObjectIsNull(b)){b=""}else{b='encoding="'+b+'"'}var c='<?xml version="1.0" '+b+"?>";if(!tool.checkObjectIsNull(a)){c+=xmloperation.createNode(a)}return c},createNode:function(d,e){if(tool.checkObjectIsNull(e)){e=true}if(tool.checkObjectIsNull(d)){return}if(tool.checkObjectIsNull(d.nodeName)){return}var c="<"+d.nodeName;if(!tool.checkObjectIsNull(d.attrArray)){for(var b=0;b<d.attrArray.length;b++){var a=d.attrArray[b];c+=" "+a.name+'="'+a.value+'"'}}var c=c+">";if(!tool.checkObjectIsNull(d.value)){if(e){c=c+"<![CDATA["+d.value+"]]>"}else{c=c+d.value}}var c=c+"</"+d.nodeName+">";return c},createNodeText:function(e,f){if(tool.checkObjectIsNull(f)){f=true}if(tool.checkObjectIsNull(e)){return}if(tool.checkObjectIsNull(e.nodeName)){return}var d="<"+e.nodeName;if(!tool.checkObjectIsNull(e.attrArray)){for(var c=0;c<e.attrArray.length;c++){var b=e.attrArray[c];d+=" "+b.name+'="'+b.value+'"'}}var d=d+">";if(!tool.checkObjectIsNull(e.value)){if(f){d=d+"<![CDATA["+e.value+"]]>"}else{d=d+e.value}}if(!tool.checkObjectIsNull(e.textArray)){if(e.textArray.length>0){for(var c=0;c<e.textArray.length;c++){var a=e.textArray[c];if(!tool.checkObjectIsNull(a.nodeName)){d=d+"<"+a.nodeName+"><![CDATA[";if(!tool.checkObjectIsNull(a.value)){d=d+a.value}d=d+"]]>"+"</"+a.nodeName+">"}}}}var d=d+"</"+e.nodeName+">";return d},addNode:function(h,c,l,e){var m=0;if(!tool.checkObjectIsNull(l)){if(tool.checkObjectIsNull(e)){e=1}var f=h;var j=0;for(var d=0;d<e;d++){j=f.indexOf(l,j);if(j==-1){return}var g=f.lastIndexOf("<",j);var b=f.lastIndexOf("</",j);if(g<=b){d--}j=j+l.length}if(j==0){return}f=f.substring(j+l.length);m+=j+l.length;j=0;var k=0;var a=true;while(a){j=f.indexOf(l);if(j==-1){return}var g=f.lastIndexOf("<",j);var b=f.lastIndexOf("</",j);if(g<=b){k--}else{k++}if(k<0){m+=b;a=false}}}else{var f=h;m=f.lastIndexOf("</");if(m==-1){return}}return h.substring(0,m)+c+h.substring(m)},getXmlNodeAttr:function(b,a){if(!b){return""}if(!b.attributes){return""}if(b.attributes[a]!=null){return b.attributes[a].value}if(b.attributes.getNamedItem(a)!=null){return b.attributes.getNamedItem(a).value}return""},getNodeValue:function(b){var a=tool.trim(b.textContent);return a}};module.exports=media;